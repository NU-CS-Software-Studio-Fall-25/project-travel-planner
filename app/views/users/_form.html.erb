<%# app/views/users/_form.html.erb %>
<%= form_with(model: user, local: true, id: "user-form") do |form| %>
  <% if user.errors.any? %>
    <div class="alert alert-danger">
      <h4><%= pluralize(user.errors.count, "error") %> prohibited this user from being saved:</h4>
      <ul class="mb-0">
        <% user.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="mb-3">
    <%= form.label :name, "Full Name", class: "form-label" %>
    <%= form.text_field :name, class: "form-control", placeholder: "Enter your full name", required: true, id: "name-field", maxlength: 75 %>
    <div class="invalid-feedback" id="name-error"></div>
  </div>

  <div class="mb-3">
    <%= form.label :email, "Email Address", class: "form-label" %>
    <%= form.email_field :email, class: "form-control", placeholder: "Enter your email address", required: true, id: "email-field", maxlength: 75 %>
    <div class="invalid-feedback" id="email-error"></div>
  </div>

  <div class="mb-3">
    <%= form.label :current_country, "Current Country", class: "form-label" %>
    <%= form.select :current_country,
                    options_for_select([
                                         ['Afghanistan', 'Afghanistan'],
                                         ['Albania', 'Albania'],
                                         ['Åland Islands', 'Åland Islands'],
                                         ['Algeria', 'Algeria'],
                                         ['American Samoa', 'American Samoa'],
                                         ['Andorra', 'Andorra'],
                                         ['Angola', 'Angola'],
                                         ['Anguilla', 'Anguilla'],
                                         ['Antarctica', 'Antarctica'],
                                         ['Antigua and Barbuda', 'Antigua and Barbuda'],
                                         ['Argentina', 'Argentina'],
                                         ['Armenia', 'Armenia'],
                                         ['Aruba', 'Aruba'],
                                         ['Australia', 'Australia'],
                                         ['Austria', 'Austria'],
                                         ['Azerbaijan', 'Azerbaijan'],
                                         ['Bahamas', 'Bahamas'],
                                         ['Bahrain', 'Bahrain'],
                                         ['Bangladesh', 'Bangladesh'],
                                         ['Barbados', 'Barbados'],
                                         ['Belarus', 'Belarus'],
                                         ['Belgium', 'Belgium'],
                                         ['Belize', 'Belize'],
                                         ['Benin', 'Benin'],
                                         ['Bermuda', 'Bermuda'],
                                         ['Bhutan', 'Bhutan'],
                                         ['Bolivia', 'Bolivia'],
                                         ['Bosnia and Herzegovina', 'Bosnia and Herzegovina'],
                                         ['Botswana', 'Botswana'],
                                         ['Bouvet Island', 'Bouvet Island'],
                                         ['Brazil', 'Brazil'],
                                         ['British Indian Ocean Territory', 'British Indian Ocean Territory'],
                                         ['Brunei Darussalam', 'Brunei Darussalam'],
                                         ['Bulgaria', 'Bulgaria'],
                                         ['Burkina Faso', 'Burkina Faso'],
                                         ['Burundi', 'Burundi'],
                                         ['Cambodia', 'Cambodia'],
                                         ['Cameroon', 'Cameroon'],
                                         ['Canada', 'Canada'],
                                         ['Cape Verde', 'Cape Verde'],
                                         ['Cayman Islands', 'Cayman Islands'],
                                         ['Central African Republic', 'Central African Republic'],
                                         ['Chad', 'Chad'],
                                         ['Chile', 'Chile'],
                                         ['China', 'China'],
                                         ['Christmas Island', 'Christmas Island'],
                                         ['Cocos (Keeling) Islands', 'Cocos (Keeling) Islands'],
                                         ['Colombia', 'Colombia'],
                                         ['Comoros', 'Comoros'],
                                         ['Congo', 'Congo'],
                                         ['Congo, The Democratic Republic of The', 'Congo, The Democratic Republic of The'],
                                         ['Cook Islands', 'Cook Islands'],
                                         ['Costa Rica', 'Costa Rica'],
                                         ['Cote D\'ivoire', 'Cote D\'ivoire'],
                                         ['Croatia', 'Croatia'],
                                         ['Cuba', 'Cuba'],
                                         ['Cyprus', 'Cyprus'],
                                         ['Czech Republic', 'Czech Republic'],
                                         ['Denmark', 'Denmark'],
                                         ['Djibouti', 'Djibouti'],
                                         ['Dominica', 'Dominica'],
                                         ['Dominican Republic', 'Dominican Republic'],
                                         ['Ecuador', 'Ecuador'],
                                         ['Egypt', 'Egypt'],
                                         ['El Salvador', 'El Salvador'],
                                         ['Equatorial Guinea', 'Equatorial Guinea'],
                                         ['Eritrea', 'Eritrea'],
                                         ['Estonia', 'Estonia'],
                                         ['Ethiopia', 'Ethiopia'],
                                         ['Falkland Islands (Malvinas)', 'Falkland Islands (Malvinas)'],
                                         ['Faroe Islands', 'Faroe Islands'],
                                         ['Fiji', 'Fiji'],
                                         ['Finland', 'Finland'],
                                         ['France', 'France'],
                                         ['French Guiana', 'French Guiana'],
                                         ['French Polynesia', 'French Polynesia'],
                                         ['French Southern Territories', 'French Southern Territories'],
                                         ['Gabon', 'Gabon'],
                                         ['Gambia', 'Gambia'],
                                         ['Georgia', 'Georgia'],
                                         ['Germany', 'Germany'],
                                         ['Ghana', 'Ghana'],
                                         ['Gibraltar', 'Gibraltar'],
                                         ['Greece', 'Greece'],
                                         ['Greenland', 'Greenland'],
                                         ['Grenada', 'Grenada'],
                                         ['Guadeloupe', 'Guadeloupe'],
                                         ['Guam', 'Guam'],
                                         ['Guatemala', 'Guatemala'],
                                         ['Guernsey', 'Guernsey'],
                                         ['Guinea', 'Guinea'],
                                         ['Guinea-bissau', 'Guinea-bissau'],
                                         ['Guyana', 'Guyana'],
                                         ['Haiti', 'Haiti'],
                                         ['Heard Island and Mcdonald Islands', 'Heard Island and Mcdonald Islands'],
                                         ['Holy See (Vatican City State)', 'Holy See (Vatican City State)'],
                                         ['Honduras', 'Honduras'],
                                         ['Hong Kong', 'Hong Kong'],
                                         ['Hungary', 'Hungary'],
                                         ['Iceland', 'Iceland'],
                                         ['India', 'India'],
                                         ['Indonesia', 'Indonesia'],
                                         ['Iran, Islamic Republic of', 'Iran, Islamic Republic of'],
                                         ['Iraq', 'Iraq'],
                                         ['Ireland', 'Ireland'],
                                         ['Isle of Man', 'Isle of Man'],
                                         ['Israel', 'Israel'],
                                         ['Italy', 'Italy'],
                                         ['Jamaica', 'Jamaica'],
                                         ['Japan', 'Japan'],
                                         ['Jersey', 'Jersey'],
                                         ['Jordan', 'Jordan'],
                                         ['Kazakhstan', 'Kazakhstan'],
                                         ['Kenya', 'Kenya'],
                                         ['Kiribati', 'Kiribati'],
                                         ['Korea, Democratic People\'s Republic of', 'Korea, Democratic People\'s Republic of'],
                                         ['Korea, Republic of', 'Korea, Republic of'],
                                         ['Kuwait', 'Kuwait'],
                                         ['Kyrgyzstan', 'Kyrgyzstan'],
                                         ['Lao People\'s Democratic Republic', 'Lao People\'s Democratic Republic'],
                                         ['Latvia', 'Latvia'],
                                         ['Lebanon', 'Lebanon'],
                                         ['Lesotho', 'Lesotho'],
                                         ['Liberia', 'Liberia'],
                                         ['Libyan Arab Jamahiriya', 'Libyan Arab Jamahiriya'],
                                         ['Liechtenstein', 'Liechtenstein'],
                                         ['Lithuania', 'Lithuania'],
                                         ['Luxembourg', 'Luxembourg'],
                                         ['Macao', 'Macao'],
                                         ['Macedonia, The Former Yugoslav Republic of', 'Macedonia, The Former Yugoslav Republic of'],
                                         ['Madagascar', 'Madagascar'],
                                         ['Malawi', 'Malawi'],
                                         ['Malaysia', 'Malaysia'],
                                         ['Maldives', 'Maldives'],
                                         ['Mali', 'Mali'],
                                         ['Malta', 'Malta'],
                                         ['Marshall Islands', 'Marshall Islands'],
                                         ['Martinique', 'Martinique'],
                                         ['Mauritania', 'Mauritania'],
                                         ['Mauritius', 'Mauritius'],
                                         ['Mayotte', 'Mayotte'],
                                         ['Mexico', 'Mexico'],
                                         ['Micronesia, Federated States of', 'Micronesia, Federated States of'],
                                         ['Moldova, Republic of', 'Moldova, Republic of'],
                                         ['Monaco', 'Monaco'],
                                         ['Mongolia', 'Mongolia'],
                                         ['Montenegro', 'Montenegro'],
                                         ['Montserrat', 'Montserrat'],
                                         ['Morocco', 'Morocco'],
                                         ['Mozambique', 'Mozambique'],
                                         ['Myanmar', 'Myanmar'],
                                         ['Namibia', 'Namibia'],
                                         ['Nauru', 'Nauru'],
                                         ['Nepal', 'Nepal'],
                                         ['Netherlands', 'Netherlands'],
                                         ['Netherlands Antilles', 'Netherlands Antilles'],
                                         ['New Caledonia', 'New Caledonia'],
                                         ['New Zealand', 'New Zealand'],
                                         ['Nicaragua', 'Nicaragua'],
                                         ['Niger', 'Niger'],
                                         ['Nigeria', 'Nigeria'],
                                         ['Niue', 'Niue'],
                                         ['Norfolk Island', 'Norfolk Island'],
                                         ['Northern Mariana Islands', 'Northern Mariana Islands'],
                                         ['Norway', 'Norway'],
                                         ['Oman', 'Oman'],
                                         ['Pakistan', 'Pakistan'],
                                         ['Palau', 'Palau'],
                                         ['Palestinian Territory, Occupied', 'Palestinian Territory, Occupied'],
                                         ['Panama', 'Panama'],
                                         ['Papua New Guinea', 'Papua New Guinea'],
                                         ['Paraguay', 'Paraguay'],
                                         ['Peru', 'Peru'],
                                         ['Philippines', 'Philippines'],
                                         ['Pitcairn', 'Pitcairn'],
                                         ['Poland', 'Poland'],
                                         ['Portugal', 'Portugal'],
                                         ['Puerto Rico', 'Puerto Rico'],
                                         ['Qatar', 'Qatar'],
                                         ['Reunion', 'Reunion'],
                                         ['Romania', 'Romania'],
                                         ['Russian Federation', 'Russian Federation'],
                                         ['Rwanda', 'Rwanda'],
                                         ['Saint Helena', 'Saint Helena'],
                                         ['Saint Kitts and Nevis', 'Saint Kitts and Nevis'],
                                         ['Saint Lucia', 'Saint Lucia'],
                                         ['Saint Pierre and Miquelon', 'Saint Pierre and Miquelon'],
                                         ['Saint Vincent and The Grenadines', 'Saint Vincent and The Grenadines'],
                                         ['Samoa', 'Samoa'],
                                         ['San Marino', 'San Marino'],
                                         ['Sao Tome and Principe', 'Sao Tome and Principe'],
                                         ['Saudi Arabia', 'Saudi Arabia'],
                                         ['Senegal', 'Senegal'],
                                         ['Serbia', 'Serbia'],
                                         ['Seychelles', 'Seychelles'],
                                         ['Sierra Leone', 'Sierra Leone'],
                                         ['Singapore', 'Singapore'],
                                         ['Slovakia', 'Slovakia'],
                                         ['Slovenia', 'Slovenia'],
                                         ['Solomon Islands', 'Solomon Islands'],
                                         ['Somalia', 'Somalia'],
                                         ['South Africa', 'South Africa'],
                                         ['South Georgia and The South Sandwich Islands', 'South Georgia and The South Sandwich Islands'],
                                         ['Spain', 'Spain'],
                                         ['Sri Lanka', 'Sri Lanka'],
                                         ['Sudan', 'Sudan'],
                                         ['Suriname', 'Suriname'],
                                         ['Svalbard and Jan Mayen', 'Svalbard and Jan Mayen'],
                                         ['Swaziland', 'Swaziland'],
                                         ['Sweden', 'Sweden'],
                                         ['Switzerland', 'Switzerland'],
                                         ['Syrian Arab Republic', 'Syrian Arab Republic'],
                                         ['Taiwan, Province of China', 'Taiwan, Province of China'],
                                         ['Tajikistan', 'Tajikistan'],
                                         ['Tanzania, United Republic of', 'Tanzania, United Republic of'],
                                         ['Thailand', 'Thailand'],
                                         ['Timor-leste', 'Timor-leste'],
                                         ['Togo', 'Togo'],
                                         ['Tokelau', 'Tokelau'],
                                         ['Tonga', 'Tonga'],
                                         ['Trinidad and Tobago', 'Trinidad and Tobago'],
                                         ['Tunisia', 'Tunisia'],
                                         ['Turkey', 'Turkey'],
                                         ['Turkmenistan', 'Turkmenistan'],
                                         ['Turks and Caicos Islands', 'Turks and Caicos Islands'],
                                         ['Tuvalu', 'Tuvalu'],
                                         ['Uganda', 'Uganda'],
                                         ['Ukraine', 'Ukraine'],
                                         ['United Arab Emirates', 'United Arab Emirates'],
                                         ['United Kingdom', 'United Kingdom'],
                                         ['United States', 'United States'],
                                         ['United States Minor Outlying Islands', 'United States Minor Outlying Islands'],
                                         ['Uruguay', 'Uruguay'],
                                         ['Uzbekistan', 'Uzbekistan'],
                                         ['Vanuatu', 'Vanuatu'],
                                         ['Venezuela', 'Venezuela'],
                                         ['Viet Nam', 'Viet Nam'],
                                         ['Virgin Islands, British', 'Virgin Islands, British'],
                                         ['Virgin Islands, U.S.', 'Virgin Islands, U.S.'],
                                         ['Wallis and Futuna', 'Wallis and Futuna'],
                                         ['Western Sahara', 'Western Sahara'],
                                         ['Yemen', 'Yemen'],
                                         ['Zambia', 'Zambia'],
                                         ['Zimbabwe', 'Zimbabwe']
                                       ], user.current_country),
                    { prompt: 'Select your current country' },
                    { class: "form-select", required: true, id: "country-field" }
    %>
    <div class="invalid-feedback" id="country-error"></div>
  </div>

  <div class="mb-3">
    <%= form.label :promo_code, "Promo Code", class: "form-label fw-semibold" %>
    <%= form.password_field :promo_code,
                            class: "form-control form-control-sm",
                            placeholder: "Enter promo code to unlock higher tier. Payment coming soon!",
                            id: "promo-code-field",
                            maxlength: 75 %>
    <div class="invalid-feedback" id="promo-error"></div>
  </div>

  <div class="mb-3">
    <%= form.label :subscription_tier, "Account Tier", class: "form-label fw-bold fs-4" %>

    <div class="row g-3">

      <% plans = [
        { key: "free", title: "Free", price: "$0", desc: "Includes up to 30 responses per month and vacations lasting up to 7 days." },
        { key: "premium", title: "Premium", price: "$14.99/mo", desc: "Includes unlimited responses and vacations lasting up to 14 days." }
      ] %>

      <% selected = user.new_record? ? "free" : user.subscription_tier %>

      <% plans.each do |plan| %>
        <div class="col-md-6">
          <label class="tier-card w-100">
            <%= form.radio_button :subscription_tier, plan[:key],
                                  class: "tier-radio",
                                  checked: (selected == plan[:key]),
                                  'data-tier': plan[:key],
                                  id: "tier-#{plan[:key]}" %>
            <div class="card p-3 tier-card-inner">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0"><%= plan[:title] %></h5>
                <span class="fw-bold fs-5"><%= plan[:price] %></span>
              </div>
              <p class="text-muted mt-2 mb-0"><%= plan[:desc] %></p>
            </div>
          </label>
        </div>
      <% end %>

    </div>
    <div class="invalid-feedback d-block" id="tier-error"></div>
  </div>

  <% if user.new_record? %>
    <div class="mb-3">
      <%= form.label :password, class: "form-label" %>
      <div class="input-group">
        <%= form.password_field :password,
                                class: "form-control",
                                placeholder: "Create a password (min 7 chars; include upper, lower, digit & special @#$%&!*)",
                                required: true,
                                id: "password-field",
                                maxlength: 75,
                                'aria-describedby': "toggle-password-btn" %>
        <button type="button" class="btn btn-outline-secondary" id="toggle-password-btn" aria-pressed="false" title="Show password" data-visible="false">
          <svg id="password-eye-icon" style="width:20px;height:20px;" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path fill="currentColor" d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/>
            <circle cx="12" cy="12" r="2.5" fill="currentColor"/>
          </svg>
        </button>
      </div>
      <div class="invalid-feedback" id="password-error"></div>
    </div>

    <div class="mb-3">
      <%= form.label :password_confirmation, "Confirm Password", class: "form-label" %>
      <div class="input-group">
        <%= form.password_field :password_confirmation,
                                class: "form-control",
                                placeholder: "Confirm your password",
                                required: true,
                                id: "password-confirm-field",
                                maxlength: 75,
                                'aria-describedby': "toggle-password-confirm-btn" %>
        <button type="button" class="btn btn-outline-secondary" id="toggle-password-confirm-btn" aria-pressed="false" title="Show password" data-visible="false">
          <svg id="password-confirm-eye-icon" style="width:20px;height:20px;" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
            <path fill="currentColor" d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/>
            <circle cx="12" cy="12" r="2.5" fill="currentColor"/>
          </svg>
        </button>
      </div>
      <div class="invalid-feedback" id="password-confirm-error"></div>
    </div>

    <div class="mb-3 form-check">
      <%= form.check_box :terms_accepted, class: "form-check-input", required: true, id: "terms-accepted-field" %>
      <%= form.label :terms_accepted, class: "form-check-label" do %>
        I agree to the <%= link_to "Terms of Service", terms_of_service_path, target: "_blank" %> and <%= link_to "Community Guidelines", community_guidelines_path, target: "_blank" %>
      <% end %>
      <div class="invalid-feedback" id="terms-error"></div>
    </div>
  <% end %>

  <div class="d-grid">
    <%= form.submit user.new_record? ? "Create Account" : "Update Profile", class: "btn btn-primary", id: "submit-btn" %>
  </div>
<% end %>

<script>
    function initUserForm() {
        // DOM elements
        const form = document.getElementById("user-form");
        const nameField = document.getElementById("name-field");
        const emailField = document.getElementById("email-field");
        const countryField = document.getElementById("country-field");
        const promoField = document.getElementById("promo-code-field");
        const tierRadios = document.querySelectorAll(".tier-radio");
        const freeTierRadio = document.querySelector(".tier-radio[data-tier='free']");
        const premiumTierRadio = document.querySelector(".tier-radio[data-tier='premium']");
        const passwordField = document.getElementById("password-field");
        const passwordConfirmField = document.getElementById("password-confirm-field");
        const submitBtn = document.getElementById("submit-btn");

        // Toggle elements (may be null if not present)
        const togglePwBtn = document.getElementById("toggle-password-btn");
        const togglePwConfirmBtn = document.getElementById("toggle-password-confirm-btn");
        const pwEyeIcon = document.getElementById("password-eye-icon");
        const pwConfirmEyeIcon = document.getElementById("password-confirm-eye-icon");

        // Error elements
        const errors = {
            name: document.getElementById("name-error"),
            email: document.getElementById("email-error"),
            country: document.getElementById("country-error"),
            promo: document.getElementById("promo-error"),
            tier: document.getElementById("tier-error"),
            password: document.getElementById("password-error"),
            passwordConfirm: document.getElementById("password-confirm-error")
        };

        const initialTier = "<%= user.subscription_tier || 'free' %>";
        const isNewRecord = <%= user.new_record? %>;
        const MAX_LENGTH = 75;

        // Validation functions ...
        function validateName(value) {
            const trimmed = value.trim();
            if (!trimmed) {
                return "Full name is required.";
            }
            if (trimmed.length < 2) {
                return "Full name must be at least 2 characters long.";
            }
            if (trimmed.length > MAX_LENGTH) {
                return `Full name cannot exceed ${MAX_LENGTH} characters.`;
            }
            return null;
        }

        function validateEmail(value) {
            if (!value) {
                return "Email is required.";
            }
            if (value.length > MAX_LENGTH) {
                return `Email cannot exceed ${MAX_LENGTH} characters.`;
            }
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(value)) {
                return "Please enter a valid email address.";
            }
            return null;
        }

        function validateCountry(value) {
            if (!value) {
                return "Please select your current country.";
            }
            return null;
        }

        function validatePromo() {
            const value = promoField.value;
            if (value.length > MAX_LENGTH) {
                return `Promo code cannot exceed ${MAX_LENGTH} characters.`;
            }
            return null;
        }

        function validatePromoForPremium() {
            const code = promoField.value.trim();
            const isValid = code === "cs397project";
            if (premiumTierRadio.checked && !isValid) {
                return "Valid promo code required to select Premium tier.";
            }
            return null;
        }

        function validateTier() {
            const selected = document.querySelector("input[name='user[subscription_tier]']:checked");
            if (!selected) {
                return "Please select an account tier.";
            }
            const promoError = validatePromo();
            if (promoError) {
                return promoError;
            }
            return validatePromoForPremium();
        }

        function validatePassword(value) {
            if (!value) {
                return "Password is required.";
            }
            if (value.length < 7) {
                return "Password must be at least 7 characters long.";
            }
            if (value.length > MAX_LENGTH) {
                return `Password cannot exceed ${MAX_LENGTH} characters.`;
            }
            const pwRegex = /(?=.{7,})(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@#\$%&!\*])/;
            if (!pwRegex.test(value)) {
                return "Password must include one uppercase, one lowercase, one digit and one special character (@#$%&!*).";
            }
            return null;
        }

        function validatePasswordConfirm(value, passwordValue) {
            if (!value) {
                return "Password confirmation is required.";
            }
            if (value !== passwordValue) {
                return "Passwords do not match.";
            }
            return null;
        }

        function showError(errorElement, message, inputElement = null) {
            errorElement.textContent = message;
            errorElement.classList.add("d-block"); // ensure feedback is visible even when not a direct sibling
            if (inputElement) {
                inputElement.classList.add("is-invalid");
                inputElement.classList.remove("is-valid");
            } else {
                const tierSection = errorElement.parentElement;
                tierSection.classList.add("is-invalid");
            }
        }

        function hideError(errorElement, inputElement = null) {
            errorElement.textContent = "";
            errorElement.classList.remove("d-block");
            if (inputElement) {
                inputElement.classList.remove("is-invalid");
                inputElement.classList.add("is-valid");
            } else {
                const tierSection = errorElement.parentElement;
                tierSection.classList.remove("is-invalid");
            }
        }

        function updateTierAvailability() {
            const code = promoField.value.trim();
            const isCodeValid = (code === "cs397project");
            const promoError = validatePromo();

            if (promoError) {
                showError(errors.promo, promoError, promoField);
                return;
            } else if (code) {
                errors.promo.textContent = "";
            }

            if (code && isCodeValid) {
                promoField.classList.add("is-valid");
                promoField.classList.remove("is-invalid");
                errors.promo.textContent = "";
            } else if (code) {
                promoField.classList.add("is-invalid");
                promoField.classList.remove("is-valid");
                showError(errors.promo, "Invalid promo code.", promoField);
            } else {
                promoField.classList.remove("is-valid", "is-invalid");
                errors.promo.textContent = "";
            }
        }

        // Prevent selecting premium without valid promo and show alert
        if (premiumTierRadio) {
            premiumTierRadio.addEventListener('change', (e) => {
                const code = promoField.value.trim();
                if (code !== "cs397project") {
                    e.target.checked = false;
                    alert("Need to enter a valid promo code before accessing premium tier");
                }
            });
        }

        // Toggle password visibility helpers (reuse for both fields)
        function setEyeOpen(iconElement) {
            if (!iconElement) return;
            iconElement.innerHTML = '<path fill="currentColor" d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/><circle cx="12" cy="12" r="2.5" fill="currentColor"/>';
        }
        function setEyeWithSlash(iconElement) {
            if (!iconElement) return;
            iconElement.innerHTML = '<path fill="currentColor" d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/><circle cx="12" cy="12" r="2.5" fill="currentColor"/><line x1="4" y1="4" x2="20" y2="20" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />'
        }

        // Attach toggle listeners only if buttons and fields exist
        if (togglePwBtn && passwordField) {
            // Ensure data-visible is initialized
            if (!togglePwBtn.hasAttribute("data-visible")) {
                togglePwBtn.setAttribute("data-visible", "false");
            }
            
            togglePwBtn.addEventListener("click", () => {
                const currentlyVisible = togglePwBtn.getAttribute("data-visible") === "true";
                if (currentlyVisible) {
                    passwordField.type = "password";
                    togglePwBtn.setAttribute("aria-pressed", "false");
                    togglePwBtn.setAttribute("title", "Show password");
                    togglePwBtn.setAttribute("data-visible", "false");
                    setEyeOpen(pwEyeIcon);
                } else {
                    passwordField.type = "text";
                    togglePwBtn.setAttribute("aria-pressed", "true");
                    togglePwBtn.setAttribute("title", "Hide password");
                    togglePwBtn.setAttribute("data-visible", "true");
                    setEyeWithSlash(pwEyeIcon);
                }
                passwordField.focus();
            });
        }

        if (togglePwConfirmBtn && passwordConfirmField) {
            // Ensure data-visible is initialized
            if (!togglePwConfirmBtn.hasAttribute("data-visible")) {
                togglePwConfirmBtn.setAttribute("data-visible", "false");
            }
            
            togglePwConfirmBtn.addEventListener("click", () => {
                const currentlyVisible = togglePwConfirmBtn.getAttribute("data-visible") === "true";
                if (currentlyVisible) {
                    passwordConfirmField.type = "password";
                    togglePwConfirmBtn.setAttribute("aria-pressed", "false");
                    togglePwConfirmBtn.setAttribute("title", "Show password");
                    togglePwConfirmBtn.setAttribute("data-visible", "false");
                    setEyeOpen(pwConfirmEyeIcon);
                } else {
                    passwordConfirmField.type = "text";
                    togglePwConfirmBtn.setAttribute("aria-pressed", "true");
                    togglePwConfirmBtn.setAttribute("title", "Hide password");
                    togglePwConfirmBtn.setAttribute("data-visible", "true");
                    setEyeWithSlash(pwConfirmEyeIcon);
                }
                passwordConfirmField.focus();
            });
        }

        // Validation on blur for name and email
        nameField.addEventListener("blur", () => {
            const error = validateName(nameField.value);
            if (error) {
                showError(errors.name, error, nameField);
            } else {
                hideError(errors.name, nameField);
            }
        });

        emailField.addEventListener("blur", () => {
            const error = validateEmail(emailField.value);
            if (error) {
                showError(errors.email, error, emailField);
            } else {
                hideError(errors.email, emailField);
            }
        });

        // Validation on blur for country
        countryField.addEventListener("change", () => {
            const error = validateCountry(countryField.value);
            if (error) {
                showError(errors.country, error, countryField);
            } else {
                hideError(errors.country, countryField);
            }
        });

        promoField.addEventListener("input", updateTierAvailability);

        tierRadios.forEach(radio => {
            radio.addEventListener("change", () => {
                const error = validateTier();
                if (error) {
                    showError(errors.tier, error);
                } else {
                    hideError(errors.tier);
                }
            });
        });

        if (isNewRecord) {
            // Password: validate on blur
            if (passwordField) {
                passwordField.addEventListener("blur", () => {
                    const error = validatePassword(passwordField.value);
                    if (error) {
                        showError(errors.password, error, passwordField);
                    } else {
                        hideError(errors.password, passwordField);
                    }
                });
            }

            // Password confirm: validate on input for match, on blur for required
            if (passwordConfirmField) {
                passwordConfirmField.addEventListener("input", () => {
                    const error = validatePasswordConfirm(passwordConfirmField.value, passwordField ? passwordField.value : "");
                    if (error && passwordConfirmField.value) {
                        showError(errors.passwordConfirm, error, passwordConfirmField);
                    } else if (passwordConfirmField.value) {
                        hideError(errors.passwordConfirm, passwordConfirmField);
                    }
                });

                passwordConfirmField.addEventListener("blur", () => {
                    const error = validatePasswordConfirm(passwordConfirmField.value, passwordField ? passwordField.value : "");
                    if (error) {
                        showError(errors.passwordConfirm, error, passwordConfirmField);
                    } else {
                        hideError(errors.passwordConfirm, passwordConfirmField);
                    }
                });

                // Also trigger password validation on confirm input (for length if confirm changes)
                passwordConfirmField.addEventListener("input", () => {
                    if (passwordField && passwordField.value) {
                        const pwError = validatePassword(passwordField.value);
                        if (pwError) {
                            showError(errors.password, pwError, passwordField);
                        }
                    }
                });
            }
        }

        // Form submit validation
        form.addEventListener("submit", (e) => {
            let isValid = true;

            // Name
            const nameError = validateName(nameField.value);
            if (nameError) {
                showError(errors.name, nameError, nameField);
                isValid = false;
            }

            // Email
            const emailError = validateEmail(emailField.value);
            if (emailError) {
                showError(errors.email, emailError, emailField);
                isValid = false;
            }

            // Country
            const countryError = validateCountry(countryField.value);
            if (countryError) {
                showError(errors.country, countryError, countryField);
                isValid = false;
            }

            // Tier and Promo
            const tierError = validateTier();
            if (tierError) {
                showError(errors.tier, tierError);
                isValid = false;
            }

            if (isNewRecord) {
                // Password
                if (passwordField) {
                    const passwordError = validatePassword(passwordField.value);
                    if (passwordError) {
                        showError(errors.password, passwordError, passwordField);
                        isValid = false;
                    }
                }

                // Password confirm
                if (passwordConfirmField) {
                    const confirmError = validatePasswordConfirm(passwordConfirmField.value, passwordField ? passwordField.value : "");
                    if (confirmError) {
                        showError(errors.passwordConfirm, confirmError, passwordConfirmField);
                        isValid = false;
                    }
                }
            }

            if (!isValid) {
                e.preventDefault();
                submitBtn.textContent = "Please fix errors above";
                setTimeout(() => {
                    submitBtn.textContent = isNewRecord ? "Create Account" : "Update Profile";
                }, 3000);
            }
        });

        // Initial validation
        updateTierAvailability();
        [nameField, emailField].forEach(field => {
            if (field.value) {
                const validator = field.id === "name-field" ? validateName :
                    validateEmail;
                const error = validator(field.value);
                if (error) {
                    const errorKey = field.id.replace('-field', '');
                    showError(errors[errorKey], error, field);
                } else {
                    const errorKey = field.id.replace('-field', '');
                    hideError(errors[errorKey], field);
                }
            }
        });
        if (countryField.value) {
            hideError(errors.country, countryField);
        }
        if (initialTier) {
            const initialRadio = document.querySelector(`input[value="${initialTier}"]`);
            if (initialRadio) {
                initialRadio.dispatchEvent(new Event("change"));
            }
        }
        if (isNewRecord) {
            if (passwordField && passwordField.value) {
                passwordField.dispatchEvent(new Event("blur"));
            }
            if (passwordConfirmField && passwordConfirmField.value) {
                passwordConfirmField.dispatchEvent(new Event("input"));
                passwordConfirmField.dispatchEvent(new Event("blur"));
            }
        }
    }
    document.addEventListener("turbo:load", initUserForm);
    document.addEventListener("turbolinks:load", initUserForm);
    document.addEventListener("DOMContentLoaded", initUserForm);
</script>