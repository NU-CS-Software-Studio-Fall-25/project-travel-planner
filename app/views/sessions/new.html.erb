<!-- app/views/sessions/new.html.erb -->
<% content_for :title, "Login" %>

<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h2 class="text-center">Login to Travel Planner</h2>
        </div>
        <div class="card-body">
          <%= form_with url: login_path, method: :post, local: true, id: "login-form" do |form| %>
            <div class="mb-3">
              <%= form.label :email, class: "form-label" %>
              <%= form.email_field :email, class: "form-control", placeholder: "Enter your email", required: true, id: "login-email-field", maxlength: 60 %>
            </div>

            <div class="mb-3">
              <%= form.label :password, class: "form-label" %>

              <div class="input-group">
                <%= form.password_field :password, class: "form-control", placeholder: "Enter your password", required: true, id: "login-password-field", maxlength: 60, 'aria-describedby': "toggle-password-btn" %>

                <button type="button" class="btn btn-outline-secondary" id="toggle-password-btn" aria-pressed="false" title="Show password" data-visible="false">
                  <svg id="eye-icon" style="width:20px;height:20px;" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                    <path fill="currentColor" d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/>
                    <circle cx="12" cy="12" r="2.5" fill="currentColor"/>
                  </svg>
                </button>
              </div>
            </div>

            <div class="d-grid">
              <%= form.submit "Login", class: "btn btn-primary", id: "login-submit-btn" %>
            </div>
            <div class="text-center mt-2">
              <%= link_to "Forgot password?", new_password_reset_path, class: "text-decoration-none" %>
            </div>
          <% end %>

          <div class="text-center my-3">
            <div class="d-flex align-items-center">
              <hr class="flex-grow-1">
              <span class="px-3 text-muted">OR</span>
              <hr class="flex-grow-1">
            </div>
          </div>

          <div class="d-grid">
            <%= link_to "/auth/google_oauth2", method: :post, class: "btn btn-outline-danger d-flex align-items-center justify-content-center", data: { turbo: false } do %>
              <svg style="width:20px;height:20px;margin-right:8px;" viewBox="0 0 24 24">
                <path fill="currentColor" d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12C5,7.9 8.2,4.73 12.2,4.73C15.29,4.73 17.1,6.7 17.1,6.7L19,4.72C19,4.72 16.56,2 12.1,2C6.42,2 2.03,6.8 2.03,12C2.03,17.05 6.16,22 12.25,22C17.6,22 21.5,18.33 21.5,12.91C21.5,11.76 21.35,11.1 21.35,11.1V11.1Z" />
              </svg>
              <span>Sign in with Google</span>
            <% end %>
          </div>

          <div class="text-center mt-3">
            <p>Don't have an account? <%= link_to "Sign up here", signup_path, class: "text-decoration-none" %></p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>

    function initLogin() {
        const form = document.getElementById("login-form");
        
        // Exit early if form doesn't exist (not on login page)
        if (!form) return;
        
        const emailField = document.getElementById("login-email-field");
        const passwordField = document.getElementById("login-password-field");
        const submitBtn = document.getElementById("login-submit-btn");
        const toggleBtn = document.getElementById("toggle-password-btn");
        const eyeIcon = document.getElementById("eye-icon");

        const MAX_LENGTH = 60;

        function validateEmail(value) {
            if (!value) return "Email is required.";
            if (value.length > MAX_LENGTH) return `Email cannot exceed ${MAX_LENGTH} characters.`;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(value)) return "Please enter a valid email address.";
            return null;
        }

        function validatePassword(value) {
            if (!value) return "Password is required.";
            if (value.length > MAX_LENGTH) return `Password cannot exceed ${MAX_LENGTH} characters.`;
            return null;
        }

        // Toggle password visibility - clone button to remove old event listeners
        if (toggleBtn && passwordField && eyeIcon) {
            // Clone button to remove all existing event listeners
            const newToggleBtn = toggleBtn.cloneNode(true);
            toggleBtn.parentNode.replaceChild(newToggleBtn, toggleBtn);
            
            // Get fresh reference to the eye icon after cloning
            const newEyeIcon = newToggleBtn.querySelector('svg');
            
            // Ensure data-visible is initialized
            if (!newToggleBtn.hasAttribute("data-visible")) {
                newToggleBtn.setAttribute("data-visible", "false");
            }
            
            newToggleBtn.addEventListener("click", function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const currentlyVisible = newToggleBtn.getAttribute("data-visible") === "true";
                if (currentlyVisible) {
                    // hide password
                    passwordField.type = "password";
                    newToggleBtn.setAttribute("aria-pressed", "false");
                    newToggleBtn.setAttribute("title", "Show password");
                    newToggleBtn.setAttribute("data-visible", "false");
                    newEyeIcon.innerHTML = '<path fill="currentColor" d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/><circle cx="12" cy="12" r="2.5" fill="currentColor"/>';
                } else {
                    // show password
                    passwordField.type = "text";
                    newToggleBtn.setAttribute("aria-pressed", "true");
                    newToggleBtn.setAttribute("title", "Hide password");
                    newToggleBtn.setAttribute("data-visible", "true");
                    newEyeIcon.innerHTML = '<path fill="currentColor" d="M12 5c-7 0-11 7-11 7s4 7 11 7 11-7 11-7-4-7-11-7zm0 12a5 5 0 1 1 0-10 5 5 0 0 1 0 10z"/><circle cx="12" cy="12" r="2.5" fill="currentColor"/><line x1="4" y1="4" x2="20" y2="20" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />';
                }
                passwordField.focus();
            }, { once: false });
        }

        // On submit: validate but do not show inline errors or validation classes
        if (form && emailField && passwordField && submitBtn) {
            form.addEventListener("submit", (e) => {
                let isValid = true;

                const emailError = validateEmail(emailField.value);
                if (emailError) isValid = false;

                const passwordError = validatePassword(passwordField.value);
                if (passwordError) isValid = false;

                if (!isValid) {
                    e.preventDefault();
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = "Please fix errors above";
                    setTimeout(() => {
                        submitBtn.textContent = originalText;
                    }, 3000);
                }
            });
        }
    }
    
    // Initialize on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initLogin);
    } else {
        initLogin();
    }
    
    // Re-initialize on Turbo navigation
    document.addEventListener("turbo:load", initLogin);
    document.addEventListener("turbo:render", initLogin);
</script>
