<div id="<%= dom_id travel_plan %>" class="mb-4">
  <div class="row g-3">
    <%# Basic Information Card %>
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header bg-primary text-white">
          <h6 class="mb-0">
            <svg class="me-2" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM2 2a1 1 0 0 0-1 1v1h14V3a1 1 0 0 0-1-1H2zm13 3H1v9a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V5z"/>
            </svg>
            Trip Dates
          </h6>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <strong class="text-muted d-block small">Start Date</strong>
            <div class="h5"><%= travel_plan.start_date&.strftime("%B %d, %Y") || "Not set" %></div>
          </div>
          <div>
            <strong class="text-muted d-block small">End Date</strong>
            <div class="h5"><%= travel_plan.end_date&.strftime("%B %d, %Y") || "Not set" %></div>
          </div>
          <% if travel_plan.start_date && travel_plan.end_date %>
            <hr>
            <div class="text-center">
              <span class="badge bg-info text-dark">
                <%= ((travel_plan.end_date - travel_plan.start_date).to_i + 1) %> days
              </span>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <%# Status and Destination Card %>
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0">
            <svg class="me-2" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
            </svg>
            Destination & Status
          </h6>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <strong class="text-muted d-block small">Destination</strong>
            <div class="h5">
              <%= travel_plan.destination&.name || "Not specified" %>
              <% if travel_plan.destination&.country %>
                <small class="text-muted">(<%= travel_plan.destination.country %>)</small>
              <% end %>
            </div>
          </div>
          <div>
            <strong class="text-muted d-block small">Status</strong>
            <div class="mt-2">
              <%
                status_colors = {
                  "planned" => "secondary",
                  "booked" => "primary",
                  "completed" => "success",
                  "cancelled" => "danger"
                }
                badge_color = status_colors[travel_plan.status] || "secondary"
              %>
              <span class="badge bg-<%= badge_color %> fs-6">
                <%= travel_plan.status&.upcase || "PLANNED" %>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <%# Trip Details Card %>
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header bg-info text-white">
          <h6 class="mb-0">
            <svg class="me-2" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1H7zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/>
              <path fill-rule="evenodd" d="M5.216 14A2.238 2.238 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.325 6.325 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1h4.216z"/>
              <path d="M4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5z"/>
            </svg>
            Trip Details
          </h6>
        </div>
        <div class="card-body">
          <% if travel_plan.number_of_travelers.present? %>
            <div class="mb-3">
              <strong class="text-muted d-block small">Number of Travelers</strong>
              <div class="h5">
                <span class="badge bg-primary fs-6">
                  <%= travel_plan.number_of_travelers %> <%= travel_plan.number_of_travelers == 1 ? 'person' : 'people' %>
                </span>
              </div>z
            </div>
          <% end %>
          <% if travel_plan.travel_style.present? %>
            <div class="mb-3">
              <strong class="text-muted d-block small">Travel Style</strong>
              <div class="h5"><%= travel_plan.travel_style %></div>
            </div>
          <% end %>
          <% if travel_plan.trip_scope.present? %>
            <div>
              <strong class="text-muted d-block small">Trip Scope</strong>
              <div class="h5"><%= travel_plan.trip_scope %></div>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <%# Budget Overview Card %>
    <div class="col-md-6">
      <div class="card h-100">
        <div class="card-header bg-success text-white">
          <h6 class="mb-0">
            <svg class="me-2" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
              <path d="M1 3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1H1zm7 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/>
              <path d="M0 5a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V5zm3 0a2 2 0 0 1-2 2v4a2 2 0 0 1 2 2h10a2 2 0 0 1 2-2V7a2 2 0 0 1-2-2H3z"/>
            </svg>
            Budget Overview
          </h6>
        </div>
        <div class="card-body">
          <% if travel_plan.number_of_travelers && travel_plan.number_of_travelers > 1 %>
            <div class="alert alert-info mb-3 py-2 small">
              <svg class="me-1" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
              </svg>
              Budget for <%= travel_plan.number_of_travelers %> travelers
            </div>
          <% end %>
          <div>
            <strong class="text-muted d-block small">Budget Range</strong>
            <div class="h5">
              $<%= number_with_delimiter((travel_plan.budget_min || 0).to_i) %> -
              $<%= number_with_delimiter((travel_plan.budget_max || 0).to_i) %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <%# Notes Card - Full Width %>
    <% if travel_plan.notes.present? %>
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-warning">
            <h6 class="mb-0">
              <svg class="me-2" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M5 0h8a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2 2 2 0 0 1-2 2H3a2 2 0 0 1-2-2h1a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1H1a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v9a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H5a1 1 0 0 0-1 1H3a2 2 0 0 1 2-2z"/>
                <path d="M1 6v-.5a.5.5 0 0 1 1 0V6h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0V9h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0v.5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1z"/>
              </svg>
              Trip Notes
            </h6>
          </div>
          <div class="card-body">
            <p class="mb-0"><%= simple_format(travel_plan.notes) %></p>
          </div>
        </div>
      </div>
    <% end %>

    <%# Itinerary Card - Full Width %>
    <% if travel_plan.itinerary.present? %>
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-info text-white">
            <h6 class="mb-0">
              <svg class="me-2" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/>
                <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z"/>
              </svg>
              Daily Itinerary
            </h6>
          </div>
          <div class="card-body">
            <% if travel_plan.itinerary.is_a?(Hash) %>
              <% travel_plan.itinerary.each_with_index do |(day, activities), index| %>
                <div class="mb-3 <%= 'pb-3 border-bottom' if index < travel_plan.itinerary.size - 1 %>">
                  <h6 class="text-primary fw-bold"><%= day.to_s.titleize %></h6>
                  <% if activities.is_a?(Array) %>
                    <ul class="list-unstyled ms-3">
                      <% activities.each do |activity| %>
                        <li class="mb-1">
                          <svg width="12" height="12" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                            <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                          </svg>
                          <%= activity %>
                        </li>
                      <% end %>
                    </ul>
                  <% else %>
                    <p class="ms-3"><%= activities %></p>
                  <% end %>
                </div>
              <% end %>
            <% else %>
              <p><%= travel_plan.itinerary %></p>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <%# Budget Breakdown Card - Full Width %>
    <% if travel_plan.budget_breakdown.present? %>
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-success text-white">
            <h6 class="mb-0">
              <svg class="me-2" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path d="M1 3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1H1zm7 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/>
                <path d="M0 5a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V5zm3 0a2 2 0 0 1-2 2v4a2 2 0 0 1 2 2h10a2 2 0 0 1 2-2V7a2 2 0 0 1-2-2H3z"/>
              </svg>
              Budget Breakdown
            </h6>
          </div>
          <div class="card-body">
            <% if travel_plan.budget_breakdown.is_a?(Hash) %>
              <div class="row g-2">
                <% travel_plan.budget_breakdown.each do |category, amount| %>
                  <% next if category.to_s.downcase.include?("total_trip_cost") %> <!-- Skip total trip cost -->

                  <%
                    text = amount.to_s

                    extracted_cost = nil
                    unit_text = nil

                    # Match patterns in priority order, including per-person and per-day-per-person variants
                    if text =~ /total[_\s]*cost[:\s]*\$?(\d+(?:\.\d+)?)/i
                      extracted_cost = $1
                      unit_text = nil
                    elsif text =~ /cost[_\s]*per[_\s]*person[:\s]*\$?(\d+(?:\.\d+)?)/i
                      extracted_cost = $1
                      unit_text = "per person"
                    elsif text =~ /cost[_\s]*per[_\s]*day[_\s]*per[_\s]*person[:\s]*\$?(\d+(?:\.\d+)?)/i
                      extracted_cost = $1
                      unit_text = "per day/person"
                    elsif text =~ /cost[_\s]*per[_\s]*day[_\s]*total[:\s]*\$?(\d+(?:\.\d+)?)/i
                      extracted_cost = $1
                      unit_text = "per day total"
                    elsif text =~ /cost[_\s]*per[_\s]*night[:\s]*\$?(\d+(?:\.\d+)?)/i
                      extracted_cost = $1
                      unit_text = "per night"
                    elsif text =~ /cost[_\s]*per[_\s]*day[:\s]*\$?(\d+(?:\.\d+)?)/i
                      extracted_cost = $1
                      unit_text = "per day"
                    elsif text =~ /cost[:\s]*\$?(\d+(?:\.\d+)?)/i
                      extracted_cost = $1
                      unit_text = nil
                    else
                      # Fallback: strip non-numeric characters
                      extracted_cost = text.gsub(/[^\d.]/, '')
                    end

                    # Build human-friendly formatted cost (keep decimals removed for badge)
                    display_amount = extracted_cost.to_f
                    display_label = "$#{number_with_delimiter(display_amount.round, delimiter: ',')}"
                    display_label += " #{unit_text}" if unit_text.present?
                  %>

                  <div class="col-md-6">
                    <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                      <span class="fw-semibold"><%= category.to_s.titleize %></span>
                      <span class="badge bg-success"><%= display_label %></span>
                    </div>
                  </div>
                <% end %>
              </div>
              <hr>

              <%
                # Compute total sum. Respect new keys:
                # - cost_per_person -> multiply by number_of_travelers when available
                # - cost_per_day_per_person -> multiply by number_of_travelers * trip_days when available
                # - cost_per_day_total -> multiply by trip_days when available
                trip_days = if travel_plan.start_date && travel_plan.end_date
                              ((travel_plan.end_date - travel_plan.start_date).to_i + 1)
                            else
                              1
                            end

                total = travel_plan.budget_breakdown.sum do |key, value|
                  next 0 if key.to_s.downcase.include?("total_trip_cost")

                  text = value.to_s

                  if text =~ /total[_\s]*cost[:\s]*\$?(\d+(?:\.\d+)?)/i
                    $1.to_f
                  elsif text =~ /cost[_\s]*per[_\s]*person[:\s]*\$?(\d+(?:\.\d+)?)/i
                    cost = $1.to_f
                    if travel_plan.number_of_travelers.present?
                      cost * travel_plan.number_of_travelers.to_f
                    else
                      cost
                    end
                  elsif text =~ /cost[_\s]*per[_\s]*day[_\s]*per[_\s]*person[:\s]*\$?(\d+(?:\.\d+)?)/i
                    cost = $1.to_f
                    travelers = travel_plan.number_of_travelers.present? ? travel_plan.number_of_travelers.to_f : 1.0
                    cost * travelers * trip_days
                  elsif text =~ /cost[_\s]*per[_\s]*day[_\s]*total[:\s]*\$?(\d+(?:\.\d+)?)/i
                    cost = $1.to_f
                    cost * trip_days
                  elsif text =~ /cost[_\s]*per[_\s]*night[:\s]*\$?(\d+(?:\.\d+)?)/i
                    $1.to_f
                  elsif text =~ /cost[_\s]*per[_\s]*day[:\s]*\$?(\d+(?:\.\d+)?)/i
                    $1.to_f
                  elsif text =~ /cost[:\s]*\$?(\d+(?:\.\d+)?)/i
                    $1.to_f
                  else
                    text.gsub(/[^\d.]/, '').to_f
                  end
                end

                formatted_total = total % 1 == 0 ? total.to_i : total.round(2)
              %>

              <div class="d-flex justify-content-between align-items-center">
                <strong class="h5 mb-0">Total Budget</strong>
                <strong class="h4 mb-0 text-success">
                  $<%= number_with_delimiter(formatted_total, delimiter: ',') %>
                </strong>
              </div>
            <% else %>
              <p><%= travel_plan.budget_breakdown %></p>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

  </div>
</div>
