<div class="container my-4">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card">
        <div class="card-header">
          <h3 class="mb-0">Change Password</h3>
        </div>
        <div class="card-body">
          <%= form_with url: update_password_user_path(@user), method: :patch, local: true, id: "change-password-form" do %>
            <div class="mb-3 position-relative">
              <label for="current_password" class="form-label">Current Password</label>
              <%= password_field_tag :current_password, nil, class: "form-control password-field", id: "current_password", autocomplete: "current-password", required: true, maxlength: 60 %>
              <div id="current-password-feedback" class="form-text text-danger" style="display:none; margin-top:0.25rem;"></div>
            </div>

            <div class="mb-3">
              <label for="password" class="form-label">New Password</label>
              <%= password_field_tag :password, nil, class: "form-control password-field", id: "password", autocomplete: "new-password", required: true, maxlength: 60 %>
              <div class="invalid-feedback" id="password-error"></div>
            </div>

            <div class="mb-3">
              <label for="password_confirmation" class="form-label">Confirm New Password</label>
              <%= password_field_tag :password_confirmation, nil, class: "form-control password-field", id: "password_confirmation", autocomplete: "new-password", required: true, maxlength: 60 %>
              <div class="invalid-feedback" id="password-confirm-error"></div>
            </div>

            <div class="d-flex justify-content-between align-items-center">
              <div>
                <button type="button" id="toggle-passwords" class="btn btn-sm btn-outline-secondary">Show Passwords</button>
              </div>
              <div>
                <%= submit_tag "Update Password", class: "btn btn-primary" %>
                <%= link_to "Cancel", user_path(@user), class: "btn btn-link" %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
    (function() {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
        const currentInput = document.getElementById('current_password');
        const currentFeedback = document.getElementById('current-password-feedback');
        const form = document.getElementById('change-password-form');
        const toggleBtn = document.getElementById('toggle-passwords');

        const passwordInput = document.getElementById('password');
        const passwordConfirmInput = document.getElementById('password_confirmation');
        const passwordError = document.getElementById('password-error');
        const passwordConfirmError = document.getElementById('password-confirm-error');

        let lastValidated = '';
        let currentValid = false;
        let debounceTimer = null;

        // --- Current password helpers ---
        function clearCurrentValidation() {
            currentInput.classList.remove('is-valid', 'is-invalid');
            currentFeedback.style.display = 'none';
            currentFeedback.textContent = '';
        }

        function setCurrentValid() {
            currentInput.classList.add('is-valid');
            currentInput.classList.remove('is-invalid');
            currentFeedback.style.display = 'none';
            currentFeedback.textContent = '';
            currentValid = true;
        }

        function setCurrentInvalid(message) {
            currentInput.classList.remove('is-valid');
            currentInput.classList.add('is-invalid');
            currentFeedback.textContent = message || 'Current password is incorrect.';
            currentFeedback.style.display = 'block';
            currentValid = false;
        }

        function verifyCurrentPassword(value) {
            if (!value) {
                clearCurrentValidation();
                currentValid = false;
                return;
            }
            if (value === lastValidated) return;
            lastValidated = value;

            fetch("<%= verify_password_user_path(@user) %>", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRF-Token": csrfToken,
                    "Accept": "application/json"
                },
                body: JSON.stringify({ current_password: value })
            }).then(function(res) {
                if (res.status === 403) {
                    setCurrentInvalid("Password change is not allowed for OAuth accounts.");
                    return;
                }
                return res.json();
            }).then(function(json) {
                if (!json) return;
                if (json.valid) {
                    setCurrentValid();
                } else {
                    setCurrentInvalid("Current password is incorrect.");
                }
            }).catch(function() {
                setCurrentInvalid("Unable to verify password. Try again.");
            });
        }

        currentInput.addEventListener('input', function(e) {
            const val = e.target.value;
            currentValid = false;
            clearCurrentValidation();
            if (debounceTimer) clearTimeout(debounceTimer);
            debounceTimer = setTimeout(function() {
                verifyCurrentPassword(val);
            }, 350);
        });

        // --- New password validation (mirrors _form.html.erb) ---
        const MAX_LENGTH = 60;
        function validatePasswordValue(value) {
            if (!value) return "Password is required.";
            if (value.length < 7) return "Password must be at least 7 characters long.";
            if (value.length > MAX_LENGTH) return `Password cannot exceed ${MAX_LENGTH} characters.`;
            const pwRegex = /(?=.{7,})(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@#\$%&!\*])/;
            if (!pwRegex.test(value)) return "Password must include one uppercase, one lowercase, one digit and one special character (@#$%&!*).";
            return null;
        }

        function validatePasswordConfirmValue(confirmValue, pwValue) {
            if (!confirmValue) return "Password confirmation is required.";
            if (confirmValue !== pwValue) return "Passwords do not match.";
            return null;
        }

        function showFieldError(inputEl, errorEl, message) {
            errorEl.textContent = message;
            inputEl.classList.add('is-invalid');
            inputEl.classList.remove('is-valid');
            errorEl.style.display = 'block';
        }

        function hideFieldError(inputEl, errorEl) {
            errorEl.textContent = '';
            inputEl.classList.remove('is-invalid');
            inputEl.classList.add('is-valid');
            errorEl.style.display = 'none';
        }

        function clearFieldState(inputEl, errorEl) {
            inputEl.classList.remove('is-valid', 'is-invalid');
            errorEl.textContent = '';
            errorEl.style.display = 'none';
        }

        // Attach listeners if elements exist
        if (passwordInput) {
            passwordInput.addEventListener('blur', function() {
                const err = validatePasswordValue(passwordInput.value);
                if (err) {
                    showFieldError(passwordInput, passwordError, err);
                } else {
                    hideFieldError(passwordInput, passwordError);
                }
            });

            passwordInput.addEventListener('input', function() {
                // live-check length and pattern but only mark valid when passes blur/submit
                if (!passwordInput.value) {
                    clearFieldState(passwordInput, passwordError);
                    return;
                }
                const err = validatePasswordValue(passwordInput.value);
                if (err) {
                    // show invalid only when there's content
                    showFieldError(passwordInput, passwordError, err);
                } else {
                    hideFieldError(passwordInput, passwordError);
                }

                // if confirm has value, also re-validate match
                if (passwordConfirmInput && passwordConfirmInput.value) {
                    const confirmErr = validatePasswordConfirmValue(passwordConfirmInput.value, passwordInput.value);
                    if (confirmErr) {
                        showFieldError(passwordConfirmInput, passwordConfirmError, confirmErr);
                    } else {
                        hideFieldError(passwordConfirmInput, passwordConfirmError);
                    }
                }
            });
        }

        if (passwordConfirmInput) {
            passwordConfirmInput.addEventListener('input', function() {
                const err = validatePasswordConfirmValue(passwordConfirmInput.value, passwordInput ? passwordInput.value : '');
                if (err) {
                    showFieldError(passwordConfirmInput, passwordConfirmError, err);
                } else {
                    hideFieldError(passwordConfirmInput, passwordConfirmError);
                }
            });

            passwordConfirmInput.addEventListener('blur', function() {
                const err = validatePasswordConfirmValue(passwordConfirmInput.value, passwordInput ? passwordInput.value : '');
                if (err) {
                    showFieldError(passwordConfirmInput, passwordConfirmError, err);
                } else {
                    hideFieldError(passwordConfirmInput, passwordConfirmError);
                }
            });
        }

        // --- Form submit: ensure current password validated and new passwords valid ---
        form.addEventListener('submit', function(e) {
            // current password check
            if (!currentValid) {
                e.preventDefault();
                setCurrentInvalid("Please enter the correct current password before submitting.");
                currentInput.focus();
                return;
            }

            // new password checks
            const pw = passwordInput ? passwordInput.value : '';
            const pwConfirm = passwordConfirmInput ? passwordConfirmInput.value : '';

            const pwErr = validatePasswordValue(pw);
            if (pwErr) {
                e.preventDefault();
                showFieldError(passwordInput, passwordError, pwErr);
                passwordInput.focus();
                return;
            }

            const confirmErr = validatePasswordConfirmValue(pwConfirm, pw);
            if (confirmErr) {
                e.preventDefault();
                showFieldError(passwordConfirmInput, passwordConfirmError, confirmErr);
                passwordConfirmInput.focus();
                return;
            }
        });

        // --- Toggle show/hide for all password fields ---
        toggleBtn.addEventListener('click', function() {
            const pwdFields = document.querySelectorAll('.password-field');
            const showing = toggleBtn.textContent.trim().toLowerCase().includes('show');
            pwdFields.forEach(function(f) {
                f.type = showing ? 'text' : 'password';
            });
            toggleBtn.textContent = showing ? 'Hide Passwords' : 'Show Passwords';
        });
    })();
</script>
