<%= form_with(model: travel_plan) do |form| %>
  <% if travel_plan.errors.any? %>
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <h5 class="alert-heading">
        <svg class="me-2" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
          <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
        </svg>
        <%= pluralize(travel_plan.errors.count, "error") %> prohibited this travel plan from being saved:
      </h5>
      <ul class="mb-0">
        <% travel_plan.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  <% end %>

  <div class="row g-3">
    <%# Hide user_id field as it should be set automatically %>
    <%= form.hidden_field :user_id, value: current_user&.id %>

    <div class="col-md-12">
      <%= form.label :destination_id, "Select Existing Destination (Optional)", class: "form-label" %>
      <%= form.select :destination_id, 
          options_from_collection_for_select(Destination.all, :id, :name, params[:destination_id] || travel_plan.destination_id),
          { include_blank: "-- Select from saved destinations --" },
          class: "form-select",
          id: "destination-select",
          data: { destinations: Destination.all.map { |d| { id: d.id, name: d.name, country: d.country } }.to_json } %>
      <small class="text-muted">Choose from your saved destinations, or create a new one below</small>
    </div>

    <div class="col-12 mt-3">
      <h6 class="text-muted">OR Create New Destination</h6>
    </div>

    <div class="col-md-6">
      <%= form.label :destination_name, "Destination Name", class: "form-label" %>
      <%= form.text_field :destination_name, 
          class: "form-control", 
          placeholder: "e.g., Paris, Banff National Park",
          id: "destination-name-field",
          maxlength: 255 %>
      <small class="text-muted">Name of the place you're visiting</small>
    </div>

    <div class="col-md-6">
      <%= form.label :destination_country, "Country", class: "form-label" %>
      <%= form.text_field :destination_country, 
          class: "form-control", 
          placeholder: "e.g., France, Canada",
          id: "destination-country-field",
          maxlength: 100 %>
      <small class="text-muted">Country of your destination</small>
    </div>

    <div class="col-md-6">
      <%= form.label :status, class: "form-label" %>
      <%= form.select :status, 
          [["Planned", "planned"], ["Booked", "booked"], ["Completed", "completed"], ["Cancelled", "cancelled"]],
          { selected: travel_plan.status || "planned" },
          class: "form-select" %>
    </div>

    <div class="col-md-6">
      <%= form.label :number_of_travelers, "Number of Travelers", class: "form-label" %>
      <%= form.number_field :number_of_travelers, 
          class: "form-control", 
          min: 1, 
          value: travel_plan.number_of_travelers || 1,
          placeholder: "1" %>
      <small class="text-muted">How many people are traveling?</small>
    </div>

    <div class="col-md-6">
      <%= form.label :start_date, "Trip Start Date", class: "form-label" %>
      <%= form.date_field :start_date, class: "form-control", min: Date.today, required: true %>
      <small class="text-muted">When does your trip start?</small>
    </div>

    <div class="col-md-6">
      <%= form.label :end_date, "Trip End Date", class: "form-label" %>
      <%= form.date_field :end_date, class: "form-control", min: Date.today, required: true %>
      <small class="text-muted">When does your trip end?</small>
    </div>

    <div class="col-md-6">
      <%= form.label :budget_min, "Minimum Budget ($)", class: "form-label" %>
      <%= form.number_field :budget_min, 
          class: "form-control", 
          min: 0, 
          step: 100,
          value: travel_plan.budget_min || 0,
          placeholder: "0" %>
      <small class="text-muted">Minimum budget for this trip</small>
    </div>

    <div class="col-md-6">
      <%= form.label :budget_max, "Maximum Budget ($)", class: "form-label" %>
      <%= form.number_field :budget_max, 
          class: "form-control", 
          min: 0, 
          step: 100,
          value: travel_plan.budget_max || 0,
          placeholder: "0" %>
      <small class="text-muted">Maximum budget for this trip</small>
    </div>

    <div class="col-12">
      <%= form.label :notes, "Trip Notes", class: "form-label" %>
      <%= form.text_area :notes,
                         class: "form-control",
                         rows: 5,
                         placeholder: "Add any notes, reminders, or special requirements for this trip...",
                         id: "trip-notes-field",
                         maxlength: 1000 %>
      <small class="text-muted">Optional: Add details about accommodations, activities, or anything you want to remember (Max 1000 characters)</small>
      <div id="notes-error" class="text-danger mt-1" style="display: none; font-size: 0.8rem;">
        Max character length reached. Cannot enter more characters.
      </div>
    </div>

    <div class="col-12 mt-4">
      <%= form.submit class: "btn btn-success btn-lg" %>
      <%= link_to "Cancel", travel_plans_path, class: "btn btn-outline-secondary btn-lg ms-2" %>
    </div>
  </div>
<% end %>

<script>
    function initTripForm() {
        const notesField = document.getElementById("trip-notes-field");
        const errorDiv = document.getElementById("notes-error");
        const maxLength = 1000;

        if (notesField) {
            notesField.addEventListener("input", function() {
                if (this.value.length >= maxLength) {
                    this.value = this.value.slice(0, maxLength);
                    errorDiv.style.display = "block";
                } else {
                    errorDiv.style.display = "none";
                }
            });
        }

        // Handle destination selection logic
        const destinationSelect = document.getElementById("destination-select");
        const destinationNameField = document.getElementById("destination-name-field");
        const destinationCountryField = document.getElementById("destination-country-field");

        if (destinationSelect && destinationNameField && destinationCountryField) {
            // Parse destinations data
            const destinationsData = JSON.parse(destinationSelect.dataset.destinations || '[]');
            
            // When selecting an existing destination, populate the new destination fields
            destinationSelect.addEventListener("change", function() {
                if (this.value) {
                    const selectedDestination = destinationsData.find(d => d.id == this.value);
                    if (selectedDestination) {
                        destinationNameField.value = selectedDestination.name;
                        destinationCountryField.value = selectedDestination.country;
                    }
                    destinationNameField.disabled = true;
                    destinationCountryField.disabled = true;
                } else {
                    destinationNameField.value = "";
                    destinationCountryField.value = "";
                    destinationNameField.disabled = false;
                    destinationCountryField.disabled = false;
                }
            });
            
            // Trigger change event on page load if a destination is pre-selected
            if (destinationSelect.value) {
                destinationSelect.dispatchEvent(new Event('change'));
            }

            // When typing a new destination, clear the select dropdown
            function handleNewDestinationInput() {
                if (destinationNameField.value || destinationCountryField.value) {
                    destinationSelect.value = "";
                }
            }

            destinationNameField.addEventListener("input", handleNewDestinationInput);
            destinationCountryField.addEventListener("input", handleNewDestinationInput);
        }
    }

    document.addEventListener("DOMContentLoaded", initTripForm);
    document.addEventListener("turbolinks:load", initTripForm);
    document.addEventListener("turbo:load", initTripForm);
</script>
