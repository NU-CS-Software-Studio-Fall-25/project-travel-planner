<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h2 class="text-center">Login to Travel Planner</h2>
        </div>
        <div class="card-body">
          <%= form_with url: login_path, method: :post, local: true, id: "login-form" do |form| %>
            <div class="mb-3">
              <%= form.label :email, class: "form-label" %>
              <%= form.email_field :email, class: "form-control", placeholder: "Enter your email", required: true, id: "login-email-field", maxlength: 60 %>
              <div class="invalid-feedback" id="login-email-error"></div>
            </div>

            <div class="mb-3">
              <%= form.label :password, class: "form-label" %>
              <%= form.password_field :password, class: "form-control", placeholder: "Enter your password", required: true, id: "login-password-field", maxlength: 60 %>
              <div class="invalid-feedback" id="login-password-error"></div>
            </div>

            <div class="d-grid">
              <%= form.submit "Login", class: "btn btn-primary", id: "login-submit-btn" %>
            </div>
          <% end %>

          <div class="text-center my-3">
            <div class="d-flex align-items-center">
              <hr class="flex-grow-1">
              <span class="px-3 text-muted">OR</span>
              <hr class="flex-grow-1">
            </div>
          </div>

          <div class="d-grid">
            <%= link_to "/auth/google_oauth2", method: :post, class: "btn btn-outline-danger d-flex align-items-center justify-content-center", data: { turbo: false } do %>
              <svg style="width:20px;height:20px;margin-right:8px;" viewBox="0 0 24 24">
                <path fill="currentColor" d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12C5,7.9 8.2,4.73 12.2,4.73C15.29,4.73 17.1,6.7 17.1,6.7L19,4.72C19,4.72 16.56,2 12.1,2C6.42,2 2.03,6.8 2.03,12C2.03,17.05 6.16,22 12.25,22C17.6,22 21.5,18.33 21.5,12.91C21.5,11.76 21.35,11.1 21.35,11.1V11.1Z" />
              </svg>
              <span>Sign in with Google</span>
            <% end %>
          </div>

          <div class="text-center mt-3">
            <p>Don't have an account? <%= link_to "Sign up here", signup_path, class: "text-decoration-none" %></p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        // DOM elements
        const form = document.getElementById("login-form");
        const emailField = document.getElementById("login-email-field");
        const passwordField = document.getElementById("login-password-field");
        const submitBtn = document.getElementById("login-submit-btn");

        // Error elements
        const errors = {
            email: document.getElementById("login-email-error"),
            password: document.getElementById("login-password-error")
        };

        const MAX_LENGTH = 60;

        // Validation functions
        function validateEmail(value) {
            if (!value) {
                return "Email is required.";
            }
            if (value.length > MAX_LENGTH) {
                return `Email cannot exceed ${MAX_LENGTH} characters.`;
            }
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(value)) {
                return "Please enter a valid email address.";
            }
            return null;
        }

        function validatePassword(value) {
            if (!value) {
                return "Password is required.";
            }
            if (value.length > MAX_LENGTH) {
                return `Password cannot exceed ${MAX_LENGTH} characters.`;
            }
            return null;
        }

        // UI update functions
        function showError(errorElement, message, inputElement) {
            errorElement.textContent = message;
            inputElement.classList.add("is-invalid");
            inputElement.classList.remove("is-valid");
        }

        function hideError(errorElement, inputElement) {
            errorElement.textContent = "";
            inputElement.classList.remove("is-invalid");
            inputElement.classList.add("is-valid");
        }

        // Validation on blur for email
        emailField.addEventListener("blur", () => {
            const error = validateEmail(emailField.value);
            if (error) {
                showError(errors.email, error, emailField);
            } else {
                hideError(errors.email, emailField);
            }
        });

        // Validation on blur for password
        passwordField.addEventListener("blur", () => {
            const error = validatePassword(passwordField.value);
            if (error) {
                showError(errors.password, error, passwordField);
            } else {
                hideError(errors.password, passwordField);
            }
        });

        // Form submit validation
        form.addEventListener("submit", (e) => {
            let isValid = true;

            // Email
            const emailError = validateEmail(emailField.value);
            if (emailError) {
                showError(errors.email, emailError, emailField);
                isValid = false;
            }

            // Password
            const passwordError = validatePassword(passwordField.value);
            if (passwordError) {
                showError(errors.password, passwordError, passwordField);
                isValid = false;
            }

            if (!isValid) {
                e.preventDefault();
                submitBtn.textContent = "Please fix errors above";
                setTimeout(() => {
                    submitBtn.textContent = "Login";
                }, 3000);
            }
        });

        // Initial validation
        [emailField, passwordField].forEach(field => {
            if (field.value) {
                const validator = field.id === "login-email-field" ? validateEmail : validatePassword;
                const error = validator(field.value);
                if (error) {
                    const errorKey = field.id === "login-email-field" ? "email" : "password";
                    showError(errors[errorKey], error, field);
                } else {
                    const errorKey = field.id === "login-email-field" ? "email" : "password";
                    hideError(errors[errorKey], field);
                }
            }
        });
    });
</script>