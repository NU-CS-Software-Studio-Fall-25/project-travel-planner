<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>SERPAPI_INTEGRATION - Travel Planner Documentation</title>

  <meta name="keywords" content="ruby,documentation,SERPAPI_INTEGRATION">
  <meta name="description" content="SERPAPI_INTEGRATION: SerpAPI Flight Integration ## Overview This project now integrates with SerpAPI&#39;s Google Flights API to provide realistic flight pricing for travel ">


<script type="text/javascript">
  var rdoc_rel_prefix = "./";
  var index_rel_prefix = "./";
</script>

<script src="./js/navigation.js" defer></script>
<script src="./js/search.js" defer></script>
<script src="./js/search_index.js" defer></script>
<script src="./js/searcher.js" defer></script>
<script src="./js/darkfish.js" defer></script>

<link href="./css/fonts.css" rel="stylesheet">
<link href="./css/rdoc.css" rel="stylesheet">


<body id="top" role="document" class="file">
<div id="navigation-toggle" role="button" tabindex="0" aria-label="Toggle sidebar" aria-expanded="true" aria-controls="navigation">
  <span aria-hidden="true">&#9776;</span>
</div>


<nav id="navigation" role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="./index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="./table_of_contents.html#pages">Pages</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search (/) for a class, method, ..." spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  
<div class="nav-section">
  <h3>Table of Contents</h3>



  <ul class="link-list" role="directory">
              <li>
            <details open>
              <summary>      <a href="#label-SerpAPI+Flight+Integration">SerpAPI Flight Integration</a>
</summary>
              <ul class="link-list" role="directory">
                          <li>      <a href="#label-Overview">Overview</a>
          <li>
            <details open>
              <summary>      <a href="#label-How+It+Works">How It Works</a>
</summary>
              <ul class="link-list" role="directory">
                          <li>      <a href="#label-Architecture">Architecture</a>
          <li>      <a href="#label-Algorithm+Flow">Algorithm Flow</a>

              </ul>
            </details>
          </li>
          <li>
            <details open>
              <summary>      <a href="#label-Configuration">Configuration</a>
</summary>
              <ul class="link-list" role="directory">
                          <li>      <a href="#label-Environment+Variables">Environment Variables</a>
          <li>      <a href="#label-Budget+Constraints">Budget Constraints</a>

              </ul>
            </details>
          </li>
          <li>
            <details open>
              <summary>      <a href="#label-API+Endpoints+Used">API Endpoints Used</a>
</summary>
              <ul class="link-list" role="directory">
                          <li>      <a href="#label-SerpAPI+Google+Flights">SerpAPI Google Flights</a>

              </ul>
            </details>
          </li>
          <li>
            <details open>
              <summary>      <a href="#label-Testing">Testing</a>
</summary>
              <ul class="link-list" role="directory">
                          <li>      <a href="#label-Run+SerpAPI+Integration+Test">Run SerpAPI Integration Test</a>
          <li>      <a href="#label-Run+Full+Iterative+Algorithm+Test">Run Full Iterative Algorithm Test</a>

              </ul>
            </details>
          </li>
          <li>
            <details open>
              <summary>      <a href="#label-Features">Features</a>
</summary>
              <ul class="link-list" role="directory">
                          <li>      <a href="#label-Real-Time+Flight+Pricing">Real-Time Flight Pricing</a>
          <li>      <a href="#label-Budget+Validation">Budget Validation</a>
          <li>      <a href="#label-Iterative+Optimization">Iterative Optimization</a>
          <li>      <a href="#label-Airport+Intelligence">Airport Intelligence</a>

              </ul>
            </details>
          </li>
          <li>      <a href="#label-Error+Handling">Error Handling</a>
          <li>      <a href="#label-Future+Enhancements">Future Enhancements</a>
          <li>      <a href="#label-Logging">Logging</a>
          <li>      <a href="#label-Support">Support</a>

              </ul>
            </details>
          </li>

  </ul>
</div>

  
<div id="fileindex-section" class="nav-section">
  <h3>Pages</h3>

  <ul class="link-list">
    <li><a href="./AIRPORT_LOOKUP_ENHANCEMENT_md.html">AIRPORT_LOOKUP_ENHANCEMENT</a>
    <li><a href="./BUG_FIX_SAFETY_PARAMETER_md.html">BUG_FIX_SAFETY_PARAMETER</a>
    <li><a href="./DESTINATION_UI_IMPROVEMENTS_md.html">DESTINATION_UI_IMPROVEMENTS</a>
    <li><a href="./DEVELOPMENT_GUIDE_md.html">DEVELOPMENT_GUIDE</a>
    <li><a href="./Dockerfile.html">Dockerfile</a>
    <li><a href="./FINAL_SECURITY_CHECKLIST_md.html">FINAL_SECURITY_CHECKLIST</a>
    <li><a href="./GPI_INTEGRATION_COMPLETE_md.html">GPI_INTEGRATION_COMPLETE</a>
    <li><a href="./Gemfile.html">Gemfile</a>
    <li><a href="./Gemfile_lock.html">Gemfile.lock</a>
    <li><a href="./HEROKU_DEPLOY_md.html">HEROKU_DEPLOY</a>
    <li><a href="./JAVASCRIPT_VALIDATION_FIX_md.html">JAVASCRIPT_VALIDATION_FIX</a>
    <li><a href="./LIKE_DISLIKE_FEATURE_md.html">LIKE_DISLIKE_FEATURE</a>
    <li><a href="./PWA_IMPLEMENTATION_md.html">PWA_IMPLEMENTATION</a>
    <li><a href="./README_md.html">README</a>
    <li><a href="./RSPEC_FIXES_SUMMARY_md.html">RSPEC_FIXES_SUMMARY</a>
    <li><a href="./RSPEC_TESTING_GUIDE_md.html">RSPEC_TESTING_GUIDE</a>
    <li><a href="./RUBY_COMPATIBILITY_md.html">RUBY_COMPATIBILITY</a>
    <li><a href="./Rakefile.html">Rakefile</a>
    <li><a href="./SAFETY_LEVEL_DISPLAY_UPDATE_md.html">SAFETY_LEVEL_DISPLAY_UPDATE</a>
    <li><a href="./SECURITY_AUDIT_LIKE_DISLIKE_md.html">SECURITY_AUDIT_LIKE_DISLIKE</a>
    <li><a href="./SERPAPI_INTEGRATION_md.html">SERPAPI_INTEGRATION</a>
    <li><a href="./TEAM_SETUP_GUIDE_md.html">TEAM_SETUP_GUIDE</a>
    <li><a href="./TRIPADVISOR_SETUP_md.html">TRIPADVISOR_SETUP</a>
    <li><a href="./TRUST_AND_SAFETY_FEATURES_md.html">TRUST_AND_SAFETY_FEATURES</a>
    <li><a href="./TRUST_SAFETY_README_md.html">TRUST_SAFETY_README</a>
    <li><a href="./VISA_API_INTEGRATION_md.html">VISA_API_INTEGRATION</a>
    <li><details><summary>app</summary>
    <ul class="link-list">
      <li><a href="./app/assets/dataset/airports_dat.html">airports.dat</a>
      <li><a href="./app/assets/stylesheets/application_css.html">application.css</a>
      <li><a href="./app/assets/stylesheets/destination_header_scss.html">destination_header.scss</a>
      <li><a href="./app/javascript/application_js.html">application.js</a>
      <li><a href="./app/javascript/controllers/application_js.html">application.js</a>
      <li><a href="./app/javascript/controllers/auto_dismiss_controller_js.html">auto_dismiss_controller.js</a>
      <li><a href="./app/javascript/controllers/hello_controller_js.html">hello_controller.js</a>
      <li><a href="./app/javascript/controllers/index_js.html">index.js</a>
      <li><a href="./app/javascript/controllers/map_controller_js.html">map_controller.js</a>
      <li><a href="./app/javascript/controllers/pwa_install_controller_js.html">pwa_install_controller.js</a>
      <li><a href="./app/javascript/controllers/save_plan_controller_js.html">save_plan_controller.js</a>
      <li><a href="./app/views/destinations/_destination_json_jbuilder.html">_destination.json.jbuilder</a>
      <li><a href="./app/views/destinations/index_json_jbuilder.html">index.json.jbuilder</a>
      <li><a href="./app/views/destinations/show_json_jbuilder.html">show.json.jbuilder</a>
      <li><a href="./app/views/pwa/service-worker_js.html">service-worker.js</a>
      <li><a href="./app/views/travel_plans/_travel_plan_json_jbuilder.html">_travel_plan.json.jbuilder</a>
      <li><a href="./app/views/travel_plans/index_json_jbuilder.html">index.json.jbuilder</a>
      <li><a href="./app/views/travel_plans/show_json_jbuilder.html">show.json.jbuilder</a>
      <li><a href="./app/views/users/_user_json_jbuilder.html">_user.json.jbuilder</a>
      <li><a href="./app/views/users/index_json_jbuilder.html">index.json.jbuilder</a>
      <li><a href="./app/views/users/show_json_jbuilder.html">show.json.jbuilder</a>
    </ul></details>
    <li><a href="./bin/docker-entrypoint.html">docker-entrypoint</a>
    <li><a href="./config_ru.html">config.ru</a>
    <li><a href="./config/credentials_yml_enc.html">credentials.yml.enc</a>
    <li><details><summary>features</summary>
    <ul class="link-list">
      <li><a href="./features/login_logout_feature.html">login_logout.feature</a>
      <li><a href="./features/travel_plans_feature.html">travel_plans.feature</a>
      <li><a href="./features/user_authentication_feature.html">user_authentication.feature</a>
    </ul></details>
    <li><a href="./lib/tasks/cucumber_rake.html">cucumber.rake</a>
    <li><details><summary>log</summary>
    <ul class="link-list">
      <li><a href="./log/development_log.html">development.log</a>
      <li><a href="./log/test_log.html">test.log</a>
    </ul></details>
    <li><details><summary>public</summary>
    <ul class="link-list">
      <li><a href="./public/400_html.html">400.html</a>
      <li><a href="./public/404_html.html">404.html</a>
      <li><a href="./public/406-unsupported-browser_html.html">406-unsupported-browser.html</a>
      <li><a href="./public/422_html.html">422.html</a>
      <li><a href="./public/500_html.html">500.html</a>
      <li><a href="./public/index_html_backup.html">index.html.backup</a>
      <li><a href="./public/js/travel-planner_js.html">travel-planner.js</a>
      <li><a href="./public/offline_html.html">offline.html</a>
      <li><a href="./public/robots_txt.html">robots</a>
      <li><a href="./public/tripadvisor-check_html.html">tripadvisor-check.html</a>
    </ul></details>
    <li><details><summary>tmp</summary>
    <ul class="link-list">
      <li><a href="./tmp/letter_opener/1764977770_8960772_f01ea09/plain_html.html">plain.html</a>
      <li><a href="./tmp/letter_opener/1764977770_8960772_f01ea09/rich_html.html">rich.html</a>
      <li><a href="./tmp/letter_opener/1764977952_0724654_88b215e/plain_html.html">plain.html</a>
      <li><a href="./tmp/letter_opener/1764977952_0724654_88b215e/rich_html.html">rich.html</a>
      <li><a href="./tmp/letter_opener/1764978131_9619157_8b50fa3/plain_html.html">plain.html</a>
      <li><a href="./tmp/letter_opener/1764978131_9619157_8b50fa3/rich_html.html">rich.html</a>
      <li><a href="./tmp/letter_opener/1765039455_3308675_81a514b/plain_html.html">plain.html</a>
      <li><a href="./tmp/letter_opener/1765039455_3308675_81a514b/rich_html.html">rich.html</a>
      <li><a href="./tmp/letter_opener/1765039587_144924_54f5afe/plain_html.html">plain.html</a>
      <li><a href="./tmp/letter_opener/1765039587_144924_54f5afe/rich_html.html">rich.html</a>
      <li><a href="./tmp/letter_opener/1765040662_3113976_be7e2c5/plain_html.html">plain.html</a>
      <li><a href="./tmp/letter_opener/1765040662_3113976_be7e2c5/rich_html.html">rich.html</a>
      <li><a href="./tmp/local_secret_txt.html">local_secret</a>
      <li><a href="./tmp/restart_txt.html">restart</a>
    </ul></details>
  </ul>
</div>


  <footer id="validator-badges" role="contentinfo">
  <p><a href="https://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://ruby.github.io/rdoc/">RDoc</a> 6.14.2.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

</nav>

<main role="main" aria-label="Page SERPAPI_INTEGRATION.md">

<h1 id="label-SerpAPI+Flight+Integration">SerpAPI Flight Integration<span><a href="#label-SerpAPI+Flight+Integration">&para;</a> <a href="#top">&uarr;</a></span></h1>

<h2 id="label-Overview">Overview<span><a href="#label-Overview">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>This project now integrates with SerpAPI’s Google Flights API to provide realistic flight pricing for travel recommendations. The system uses an iterative algorithm to find destinations that fit within the user’s budget constraints.</p>

<h2 id="label-How+It+Works">How It Works<span><a href="#label-How+It+Works">&para;</a> <a href="#top">&uarr;</a></span></h2>

<h3 id="label-Architecture">Architecture<span><a href="#label-Architecture">&para;</a> <a href="#top">&uarr;</a></span></h3>
<ol><li>
<p><strong>AirportLookupService</strong> (<code>app/Services/airport_lookup_service.rb</code>)</p>
</li><li>
<p>Maps cities and locations to airport codes (IATA)</p>
</li><li>
<p>Supports major airports worldwide</p>
</li><li>
<p>Handles location parsing from Google Maps format</p>
</li><li>
<p><strong>SerpapiFlightService</strong> (<code>app/Services/serpapi_flight_service.rb</code>)</p>
</li><li>
<p>Connects to SerpAPI Google Flights API</p>
</li><li>
<p>Fetches real-time flight prices</p>
</li><li>
<p>Returns flight details including duration, stops, and airline info</p>
</li><li>
<p><strong>OpenaiService</strong> (Modified) (<code>app/Services/openai_service.rb</code>)</p>
</li><li>
<p><strong>NEW: Iterative Algorithm</strong></p>
</li><li>
<p>Step 1: Ask OpenAI for a destination city (not full plan)</p>
</li><li>
<p>Step 2: Query SerpAPI for actual flight prices</p>
</li><li>
<p>Step 3: Validate flight cost against budget (must be &lt; 50% of max budget)</p>
</li><li>
<p>Step 4: If valid, request full travel plan from OpenAI with real flight data</p>
</li><li>
<p>Step 5: If invalid, reject and try again (max 3 attempts)</p>
</li></ol>

<h3 id="label-Algorithm+Flow">Algorithm Flow<span><a href="#label-Algorithm+Flow">&para;</a> <a href="#top">&uarr;</a></span></h3>

<pre>User submits preferences
    ↓
┌─────────────────────────────────┐
│ Iteration Loop (Max 3 attempts) │
└─────────────────────────────────┘
    ↓
1. OpenAI suggests a city
    ↓
2. SerpAPI checks flight prices
    ↓
3. Is flight &lt; 50% of max budget?
    ├─ YES → Get full plan from OpenAI → Return to user ✓
    └─ NO → Add to rejected list → Loop again
    ↓
After 3 failed attempts:
    Return &quot;No suitable destination&quot; message with suggestions</pre>

<h2 id="label-Configuration">Configuration<span><a href="#label-Configuration">&para;</a> <a href="#top">&uarr;</a></span></h2>

<h3 id="label-Environment+Variables">Environment Variables<span><a href="#label-Environment+Variables">&para;</a> <a href="#top">&uarr;</a></span></h3>

<p>Add your SerpAPI key to your environment:</p>

<pre class="ruby"><span class="ruby-comment"># In your .env file or environment</span>
<span class="ruby-constant">SERPAPI_KEY</span>=<span class="ruby-identifier">your_api_key_here</span>
</pre>

<p>Current key (in code): <code>96e7a7f8814b6000ef60d17202cedca1b66d061c4024101b2dcb3152ffa33ff4</code></p>

<h3 id="label-Budget+Constraints">Budget Constraints<span><a href="#label-Budget+Constraints">&para;</a> <a href="#top">&uarr;</a></span></h3>
<ul><li>
<p><strong>Flight Budget Threshold</strong>: 50% of max budget</p>
</li><li>
<p><strong>Max Iterations</strong>: 3 attempts</p>
</li><li>
<p>If no suitable destination found after 3 attempts, user receives helpful feedback</p>
</li></ul>

<h2 id="label-API+Endpoints+Used">API Endpoints Used<span><a href="#label-API+Endpoints+Used">&para;</a> <a href="#top">&uarr;</a></span></h2>

<h3 id="label-SerpAPI+Google+Flights">SerpAPI Google Flights<span><a href="#label-SerpAPI+Google+Flights">&para;</a> <a href="#top">&uarr;</a></span></h3>
<ul><li>
<p><strong>Endpoint</strong>: <code>https://serpapi.com/search?engine=google_flights</code></p>
</li><li>
<p><strong>Parameters</strong>:</p>
</li><li>
<p><code>departure_id</code>: IATA airport code (e.g., ORD, JFK)</p>
</li><li>
<p><code>arrival_id</code>: IATA airport code (e.g., CDG, NRT)</p>
</li><li>
<p><code>outbound_date</code>: YYYY-MM-DD format</p>
</li><li>
<p><code>return_date</code>: YYYY-MM-DD format</p>
</li><li>
<p><code>type</code>: 1 (round trip)</p>
</li><li>
<p><code>adults</code>: Number of travelers</p>
</li><li>
<p><code>currency</code>: USD</p>
</li><li>
<p><code>travel_class</code>: 1 (economy)</p>
</li></ul>

<h2 id="label-Testing">Testing<span><a href="#label-Testing">&para;</a> <a href="#top">&uarr;</a></span></h2>

<h3 id="label-Run+SerpAPI+Integration+Test">Run SerpAPI Integration Test<span><a href="#label-Run+SerpAPI+Integration+Test">&para;</a> <a href="#top">&uarr;</a></span></h3>

<pre class="ruby"><span class="ruby-identifier">rails</span> <span class="ruby-identifier">runner</span> <span class="ruby-identifier">test</span><span class="ruby-operator">/</span><span class="ruby-identifier">services</span><span class="ruby-operator">/</span><span class="ruby-identifier">serpapi_integration_test</span>.<span class="ruby-identifier">rb</span>
</pre>

<p>Tests: - Airport lookup functionality - SerpAPI flight price retrieval - Data parsing and formatting</p>

<h3 id="label-Run+Full+Iterative+Algorithm+Test">Run Full Iterative Algorithm Test<span><a href="#label-Run+Full+Iterative+Algorithm+Test">&para;</a> <a href="#top">&uarr;</a></span></h3>

<pre class="ruby"><span class="ruby-identifier">rails</span> <span class="ruby-identifier">runner</span> <span class="ruby-identifier">test</span><span class="ruby-operator">/</span><span class="ruby-identifier">services</span><span class="ruby-operator">/</span><span class="ruby-identifier">openai_iterative_test</span>.<span class="ruby-identifier">rb</span>
</pre>

<p>Tests: - Complete recommendation flow - OpenAI + SerpAPI integration - Budget validation - Error handling</p>

<h2 id="label-Features">Features<span><a href="#label-Features">&para;</a> <a href="#top">&uarr;</a></span></h2>

<h3 id="label-Real-Time+Flight+Pricing">Real-Time Flight Pricing<span><a href="#label-Real-Time+Flight+Pricing">&para;</a> <a href="#top">&uarr;</a></span></h3>
<ul><li>
<p>Actual flight costs from Google Flights</p>
</li><li>
<p>Includes airline, duration, and stop information</p>
</li><li>
<p>Updates dynamically based on search dates</p>
</li></ul>

<h3 id="label-Budget+Validation">Budget Validation<span><a href="#label-Budget+Validation">&para;</a> <a href="#top">&uarr;</a></span></h3>
<ul><li>
<p>Ensures flights don’t exceed 50% of total budget</p>
</li><li>
<p>Leaves adequate budget for accommodation, food, and activities</p>
</li><li>
<p>Prevents unrealistic recommendations</p>
</li></ul>

<h3 id="label-Iterative+Optimization">Iterative Optimization<span><a href="#label-Iterative+Optimization">&para;</a> <a href="#top">&uarr;</a></span></h3>
<ul><li>
<p>Automatically retries with different destinations</p>
</li><li>
<p>Tracks rejected cities to avoid repeats</p>
</li><li>
<p>Provides clear feedback if no suitable options found</p>
</li></ul>

<h3 id="label-Airport+Intelligence">Airport Intelligence<span><a href="#label-Airport+Intelligence">&para;</a> <a href="#top">&uarr;</a></span></h3>
<ul><li>
<p>Automatically finds nearest airports for user’s location</p>
</li><li>
<p>Matches destination cities to appropriate airports</p>
</li><li>
<p><strong>Multi-Airport Search</strong>: For cities with multiple airports, checks up to 3 airports</p>
</li><li>
<p><strong>Smart Prioritization</strong>: Prioritizes international/major airports first</p>
</li><li>
<p>Example: JFK before LGA for New York</p>
</li><li>
<p>Example: LHR before Luton for London</p>
</li><li>
<p><strong>Best Price Selection</strong>: Compares prices across all available airports and returns cheapest option</p>
</li><li>
<p>Handles 7,699+ airports worldwide from comprehensive dataset</p>
</li></ul>

<h2 id="label-Error+Handling">Error Handling<span><a href="#label-Error+Handling">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>The system gracefully handles: - API failures (SerpAPI or OpenAI) - Missing airport data - No flights available for route - Budget constraints too restrictive - Network timeouts</p>

<p>Error responses include: - Clear error messages - Rejected destinations with reasons - Actionable suggestions for users</p>

<h2 id="label-Future+Enhancements">Future Enhancements<span><a href="#label-Future+Enhancements">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>Potential improvements: - Cache flight prices for popular routes - Support one-way and multi-city trips - Allow flexible date searches (+/- 3 days) - Include budget airlines filter - Add flight class preferences (economy, business, first)</p>

<h2 id="label-Logging">Logging<span><a href="#label-Logging">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>The system provides detailed logging: - SerpAPI request/response details - Flight price validation results - OpenAI iteration progress - Rejected cities and reasons</p>

<p>Check logs with:</p>

<pre>tail -f log/development.log</pre>

<h2 id="label-Support">Support<span><a href="#label-Support">&para;</a> <a href="#top">&uarr;</a></span></h2>

<p>For issues or questions: 1. Check logs for detailed error messages 2. Verify SerpAPI key is valid 3. Ensure OpenAI API key is configured 4. Test individual services with provided test scripts</p>

</main>

