<% content_for :title, "Destinations" %>

<style>
  .destination-row {
    transition: all 0.2s ease-in-out;
  }
  .destination-row:hover {
    background-color: #e3f2fd !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    transform: translateX(4px);
  }
  .table {
    border-radius: 12px;
    overflow: hidden;
  }
  .pagination .page-link {
    cursor: pointer;
    pointer-events: auto;
  }
  .pagination .page-item.disabled .page-link,
  .pagination .page-item.disabled span {
    cursor: not-allowed;
    pointer-events: none;
  }
</style>

<div class="container my-5">
  <p class="mt-2 text-success"><%= notice %></p>
  <h1 class="mb-2 text-center">Explore Popular Destinations</h1>
  <p class="text-center text-muted mb-4">
    <i class="bi bi-info-circle"></i> Click on any destination to explore details, view on map, and manage your plans
  </p>
  
  <!-- Filter Bar -->
  <div class="card mb-4">
    <div class="card-body">
      <%= form_with url: destinations_path, method: :get, local: true, class: "row g-3 align-items-end" do |f| %>
        <div class="col-md-3">
          <label for="search" class="form-label small">Search by name</label>
          <%= text_field_tag :search, params[:search], class: "form-control", placeholder: "Enter destination name..." %>
        </div>
        
        <div class="col-md-2">
          <label for="country_filter" class="form-label small">Country</label>
          <%= select_tag :country_filter, 
              options_for_select(
                [['All', 'all'], ['Domestic', 'domestic'], ['International', 'international']], 
                params[:country_filter] || 'all'
              ), 
              class: "form-select" %>
        </div>
        
        <div class="col-md-2">
          <label for="visa_filter" class="form-label small">Visa</label>
          <%= select_tag :visa_filter, 
              options_for_select(
                [['All', 'all'], ['Not Required', 'not_required'], ['Required', 'required']], 
                params[:visa_filter] || 'all'
              ), 
              class: "form-select" %>
        </div>
        
        <div class="col-md-3">
          <label for="safety_sort" class="form-label small">Safety</label>
          <%= select_tag :safety_sort, 
              options_for_select(
                [['Default', 'default'], ['High to Low', 'high_to_low'], ['Low to High', 'low_to_high']], 
                params[:safety_sort] || 'default'
              ), 
              class: "form-select" %>
        </div>
        
        <div class="col-md-2">
          <label class="form-label small d-block">&nbsp;</label>
          <%= button_tag type: 'submit', class: "btn btn-primary w-100" do %>
            <i class="bi bi-search"></i> Search
          <% end %>
          <%= link_to "Clear", destinations_path, class: "btn btn-outline-secondary w-100 mt-2" %>
        </div>
      <% end %>
    </div>
  </div>

  <% if @destinations.any? %>
    <!-- All Destinations Table -->
    <div class="mb-5">
      <h2 class="mb-3">
        <i class="bi bi-globe"></i> All Destinations
      </h2>
      <table class="table table-striped table-hover rounded shadow">
        <thead class="table-primary">
          <tr>
            <th>Name</th>
            <th>Country</th>
            <th>Visa Required</th>
            <th>Safety</th>
          </tr>
        </thead>
        <tbody>
          <% @destinations.each do |destination| %>
            <% is_domestic = current_user&.current_country.present? && destination.country == current_user.current_country %>
            <tr style="cursor: pointer;" onclick="window.location='<%= destination_path(destination) %>'" class="destination-row">
              <td class="fw-bold"><%= destination.name %></td>
              <td><%= destination.country %></td>
              <td>
                <span class="badge <%= is_domestic ? 'bg-success' : (destination.visa_required ? 'bg-danger' : 'bg-success') %>">
                  <%= is_domestic ? "No" : (destination.visa_required ? "Yes" : "No") %>
                </span>
              </td>
              <td>
                <span class="badge bg-info text-dark"><%= destination.safety_score %>/10</span>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% else %>
    <div class="alert alert-info text-center">
      <p class="mb-0">No destinations available. <%= link_to "Add the first destination", new_destination_path, class: "alert-link" %>.</p>
    </div>
  <% end %>

  <!-- Unified Pagination at Bottom -->
  <% if defined?(@pagy) && @pagy.pages > 1 %>
    <div class="mt-4">
      <nav aria-label="Destinations pagination">
        <ul class="pagination justify-content-center">
          <% (1..@pagy.pages).each do |page_num| %>
            <% if page_num == @pagy.page %>
              <li class="page-item active" aria-current="page">
                <a class="page-link" href="#"><%= page_num %></a>
              </li>
            <% else %>
              <li class="page-item">
                <%= link_to page_num, destinations_path(page: page_num, search: params[:search], country_filter: params[:country_filter], visa_filter: params[:visa_filter], safety_sort: params[:safety_sort]), class: 'page-link' %>
              </li>
            <% end %>
          <% end %>
        </ul>
        <p class="text-center text-muted small">Page <%= @pagy.page %> of <%= @pagy.pages %> (<%= @pagy.count %> total destinations)</p>
      </nav>
    </div>
  <% end %>
</div>
