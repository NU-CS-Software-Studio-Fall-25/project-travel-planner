<% content_for :title, "My Travel Plans" %>

<div class="container mt-4">
  <h1 class="mb-4">My Saved Travel Plans</h1>

  <% if @travel_plans.any? %>
    <div class="row">
      <% @travel_plans.each do |travel_plan| %>
        <div class="col-12 mb-4">
          <div class="card h-100 shadow">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
              <h4 class="card-title mb-0">
                <%= travel_plan.name || travel_plan.destination.name %> - <%= travel_plan.destination_country || travel_plan.destination.country %>
              </h4>
              <span class="badge bg-light text-success">SAVED</span>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-8">
                  <% if travel_plan.description.present? %>
                    <p><strong>Description:</strong> <%= travel_plan.description %></p>
                  <% end %>
                  
                  <% if travel_plan.details.present? %>
                    <p><strong>Details:</strong> <%= travel_plan.details %></p>
                  <% end %>

                  <p><strong>Dates:</strong> <%= travel_plan.start_date&.strftime("%B %d, %Y") %> - <%= travel_plan.end_date&.strftime("%B %d, %Y") %></p>
                  <p><strong>Status:</strong> <span class="badge bg-info"><%= travel_plan.status&.titleize %></span></p>

                  <%# Itinerary Accordion %>
                  <% if travel_plan.itinerary.is_a?(Hash) && travel_plan.itinerary.present? %>
                    <div class="accordion mt-3" id="accordion-itinerary-<%= travel_plan.id %>">
                      <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-itinerary-<%= travel_plan.id %>">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-itinerary-<%= travel_plan.id %>">
                            View Detailed Itinerary
                          </button>
                        </h2>
                        <div id="collapse-itinerary-<%= travel_plan.id %>" class="accordion-collapse collapse">
                          <div class="accordion-body">
                            <% travel_plan.itinerary.each do |day, description| %>
                              <div class="mb-3">
                                <strong><%= day.to_s.humanize %>:</strong>
                                <p><%= description %></p>
                              </div>
                            <% end %>
                          </div>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
                
                <div class="col-md-4">
                  <ul class="list-group list-group-flush">
                    <% if travel_plan.budget_min.present? && travel_plan.budget_max.present? %>
                      <li class="list-group-item"><strong>Budget:</strong> $<%= number_with_delimiter(travel_plan.budget_min) %> - $<%= number_with_delimiter(travel_plan.budget_max) %></li>
                    <% end %>
                    
                    <% if travel_plan.safety_score.present? %>
                      <% safety_level = safety_score_to_level(travel_plan.safety_score) %>
                      <li class="list-group-item">
                        <strong>Safety Level:</strong>
                        <span class="badge <%= safety_level_badge_class(safety_level) %>">
                          <%= safety_level_text(safety_level) %>
                        </span>
                      </li>
                    <% end %>
                    
                    <% if travel_plan.travel_style.present? %>
                      <li class="list-group-item"><strong>Travel Style:</strong> <%= travel_plan.travel_style %></li>
                    <% end %>
                    
                    <% if travel_plan.visa_info.present? %>
                      <li class="list-group-item"><strong>Visa Info:</strong> <%= travel_plan.visa_info %></li>
                    <% end %>
                  </ul>

                  <%# Budget Breakdown Accordion %>
                  <% if travel_plan.budget_breakdown.present? %>
                    <div class="accordion mt-3" id="accordion-budget-<%= travel_plan.id %>">
                      <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-budget-<%= travel_plan.id %>">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-budget-<%= travel_plan.id %>">
                            View Budget Breakdown
                          </button>
                        </h2>
                        <div id="collapse-budget-<%= travel_plan.id %>" class="accordion-collapse collapse">
                          <div class="accordion-body">
                            <ul class="list-unstyled">
                              <% travel_plan.budget_breakdown.each do |item, cost| %>
                                <li><strong><%= item.to_s.humanize %>:</strong> $<%= number_with_delimiter(cost) %></li>
                              <% end %>
                            </ul>
                          </div>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
            
            <div class="card-footer bg-white d-flex justify-content-between">
              <%= link_to "View Details", travel_plan, class: "btn btn-primary" %>
              <div class="d-flex gap-2">
                <%= link_to "Edit", edit_travel_plan_path(travel_plan), class: "btn btn-outline-secondary" %>
                <%= button_to "Delete", travel_plan, method: :delete, class: "btn btn-outline-danger", form: { data: { turbo_confirm: "Are you sure you want to delete this travel plan?" } } %>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="alert alert-info">
      <h4>No saved travel plans yet!</h4>
      <p>Visit the <%= link_to "Travel Recommendations", travel_recommendations_path, class: "alert-link" %> page to get AI-powered suggestions and save them to your plans.</p>
    </div>
  <% end %>

  <div class="mt-4">
    <%= link_to "Get New Recommendations", travel_recommendations_path, class: "btn btn-success" %>
    <%= link_to "Create Manual Plan", new_travel_plan_path, class: "btn btn-outline-primary" %>
  </div>
</div>
