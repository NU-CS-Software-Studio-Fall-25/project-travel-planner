<%= form_with(model: destination, html: { id: "destination-form" }) do |form| %>
  <% if destination.errors.any? %>
    <div class="alert alert-danger">
      <h4><%= pluralize(destination.errors.count, "error") %> prohibited this destination from being saved:</h4>
      <ul class="mb-0">
        <% destination.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="mb-3">
    <%= form.label :name, "Destination Name", class: "form-label" %>
    <%= form.text_field :name, class: "form-control", placeholder: "e.g., Paris, Tokyo, New York", maxlength: 75, required: true %>
  </div>

  <div class="row">
    <div class="col-md-6 mb-3">
      <%= form.label :city, "City/Location", class: "form-label" %>
      <%= form.text_field :city, class: "form-control", placeholder: "e.g., Paris, Tokyo, Burlington, Vermont", maxlength: 75, required: true, id: "city-field" %>
      <small class="form-text text-muted">Include state/province for ambiguous city names.</small>
    </div>

    <div class="col-md-6 mb-3">
      <%= form.label :country, "Country", class: "form-label" %>
      <%= form.select :current_country,
                      options_for_select([
                                           ['Afghanistan', 'Afghanistan'],
                                           ['Albania', 'Albania'],
                                           ['Åland Islands', 'Åland Islands'],
                                           ['Algeria', 'Algeria'],
                                           ['American Samoa', 'American Samoa'],
                                           ['Andorra', 'Andorra'],
                                           ['Angola', 'Angola'],
                                           ['Anguilla', 'Anguilla'],
                                           ['Antarctica', 'Antarctica'],
                                           ['Antigua and Barbuda', 'Antigua and Barbuda'],
                                           ['Argentina', 'Argentina'],
                                           ['Armenia', 'Armenia'],
                                           ['Aruba', 'Aruba'],
                                           ['Australia', 'Australia'],
                                           ['Austria', 'Austria'],
                                           ['Azerbaijan', 'Azerbaijan'],
                                           ['Bahamas', 'Bahamas'],
                                           ['Bahrain', 'Bahrain'],
                                           ['Bangladesh', 'Bangladesh'],
                                           ['Barbados', 'Barbados'],
                                           ['Belarus', 'Belarus'],
                                           ['Belgium', 'Belgium'],
                                           ['Belize', 'Belize'],
                                           ['Benin', 'Benin'],
                                           ['Bermuda', 'Bermuda'],
                                           ['Bhutan', 'Bhutan'],
                                           ['Bolivia', 'Bolivia'],
                                           ['Bosnia and Herzegovina', 'Bosnia and Herzegovina'],
                                           ['Botswana', 'Botswana'],
                                           ['Bouvet Island', 'Bouvet Island'],
                                           ['Brazil', 'Brazil'],
                                           ['British Indian Ocean Territory', 'British Indian Ocean Territory'],
                                           ['Brunei Darussalam', 'Brunei Darussalam'],
                                           ['Bulgaria', 'Bulgaria'],
                                           ['Burkina Faso', 'Burkina Faso'],
                                           ['Burundi', 'Burundi'],
                                           ['Cambodia', 'Cambodia'],
                                           ['Cameroon', 'Cameroon'],
                                           ['Canada', 'Canada'],
                                           ['Cape Verde', 'Cape Verde'],
                                           ['Cayman Islands', 'Cayman Islands'],
                                           ['Central African Republic', 'Central African Republic'],
                                           ['Chad', 'Chad'],
                                           ['Chile', 'Chile'],
                                           ['China', 'China'],
                                           ['Christmas Island', 'Christmas Island'],
                                           ['Cocos (Keeling) Islands', 'Cocos (Keeling) Islands'],
                                           ['Colombia', 'Colombia'],
                                           ['Comoros', 'Comoros'],
                                           ['Congo', 'Congo'],
                                           ['Congo, The Democratic Republic of The', 'Congo, The Democratic Republic of The'],
                                           ['Cook Islands', 'Cook Islands'],
                                           ['Costa Rica', 'Costa Rica'],
                                           ['Cote D\'ivoire', 'Cote D\'ivoire'],
                                           ['Croatia', 'Croatia'],
                                           ['Cuba', 'Cuba'],
                                           ['Cyprus', 'Cyprus'],
                                           ['Czech Republic', 'Czech Republic'],
                                           ['Denmark', 'Denmark'],
                                           ['Djibouti', 'Djibouti'],
                                           ['Dominica', 'Dominica'],
                                           ['Dominican Republic', 'Dominican Republic'],
                                           ['Ecuador', 'Ecuador'],
                                           ['Egypt', 'Egypt'],
                                           ['El Salvador', 'El Salvador'],
                                           ['Equatorial Guinea', 'Equatorial Guinea'],
                                           ['Eritrea', 'Eritrea'],
                                           ['Estonia', 'Estonia'],
                                           ['Ethiopia', 'Ethiopia'],
                                           ['Falkland Islands (Malvinas)', 'Falkland Islands (Malvinas)'],
                                           ['Faroe Islands', 'Faroe Islands'],
                                           ['Fiji', 'Fiji'],
                                           ['Finland', 'Finland'],
                                           ['France', 'France'],
                                           ['French Guiana', 'French Guiana'],
                                           ['French Polynesia', 'French Polynesia'],
                                           ['French Southern Territories', 'French Southern Territories'],
                                           ['Gabon', 'Gabon'],
                                           ['Gambia', 'Gambia'],
                                           ['Georgia', 'Georgia'],
                                           ['Germany', 'Germany'],
                                           ['Ghana', 'Ghana'],
                                           ['Gibraltar', 'Gibraltar'],
                                           ['Greece', 'Greece'],
                                           ['Greenland', 'Greenland'],
                                           ['Grenada', 'Grenada'],
                                           ['Guadeloupe', 'Guadeloupe'],
                                           ['Guam', 'Guam'],
                                           ['Guatemala', 'Guatemala'],
                                           ['Guernsey', 'Guernsey'],
                                           ['Guinea', 'Guinea'],
                                           ['Guinea-bissau', 'Guinea-bissau'],
                                           ['Guyana', 'Guyana'],
                                           ['Haiti', 'Haiti'],
                                           ['Heard Island and Mcdonald Islands', 'Heard Island and Mcdonald Islands'],
                                           ['Holy See (Vatican City State)', 'Holy See (Vatican City State)'],
                                           ['Honduras', 'Honduras'],
                                           ['Hong Kong', 'Hong Kong'],
                                           ['Hungary', 'Hungary'],
                                           ['Iceland', 'Iceland'],
                                           ['India', 'India'],
                                           ['Indonesia', 'Indonesia'],
                                           ['Iran, Islamic Republic of', 'Iran, Islamic Republic of'],
                                           ['Iraq', 'Iraq'],
                                           ['Ireland', 'Ireland'],
                                           ['Isle of Man', 'Isle of Man'],
                                           ['Israel', 'Israel'],
                                           ['Italy', 'Italy'],
                                           ['Jamaica', 'Jamaica'],
                                           ['Japan', 'Japan'],
                                           ['Jersey', 'Jersey'],
                                           ['Jordan', 'Jordan'],
                                           ['Kazakhstan', 'Kazakhstan'],
                                           ['Kenya', 'Kenya'],
                                           ['Kiribati', 'Kiribati'],
                                           ['Korea, Democratic People\'s Republic of', 'Korea, Democratic People\'s Republic of'],
                                           ['Korea, Republic of', 'Korea, Republic of'],
                                           ['Kuwait', 'Kuwait'],
                                           ['Kyrgyzstan', 'Kyrgyzstan'],
                                           ['Lao People\'s Democratic Republic', 'Lao People\'s Democratic Republic'],
                                           ['Latvia', 'Latvia'],
                                           ['Lebanon', 'Lebanon'],
                                           ['Lesotho', 'Lesotho'],
                                           ['Liberia', 'Liberia'],
                                           ['Libyan Arab Jamahiriya', 'Libyan Arab Jamahiriya'],
                                           ['Liechtenstein', 'Liechtenstein'],
                                           ['Lithuania', 'Lithuania'],
                                           ['Luxembourg', 'Luxembourg'],
                                           ['Macao', 'Macao'],
                                           ['Macedonia, The Former Yugoslav Republic of', 'Macedonia, The Former Yugoslav Republic of'],
                                           ['Madagascar', 'Madagascar'],
                                           ['Malawi', 'Malawi'],
                                           ['Malaysia', 'Malaysia'],
                                           ['Maldives', 'Maldives'],
                                           ['Mali', 'Mali'],
                                           ['Malta', 'Malta'],
                                           ['Marshall Islands', 'Marshall Islands'],
                                           ['Martinique', 'Martinique'],
                                           ['Mauritania', 'Mauritania'],
                                           ['Mauritius', 'Mauritius'],
                                           ['Mayotte', 'Mayotte'],
                                           ['Mexico', 'Mexico'],
                                           ['Micronesia, Federated States of', 'Micronesia, Federated States of'],
                                           ['Moldova, Republic of', 'Moldova, Republic of'],
                                           ['Monaco', 'Monaco'],
                                           ['Mongolia', 'Mongolia'],
                                           ['Montenegro', 'Montenegro'],
                                           ['Montserrat', 'Montserrat'],
                                           ['Morocco', 'Morocco'],
                                           ['Mozambique', 'Mozambique'],
                                           ['Myanmar', 'Myanmar'],
                                           ['Namibia', 'Namibia'],
                                           ['Nauru', 'Nauru'],
                                           ['Nepal', 'Nepal'],
                                           ['Netherlands', 'Netherlands'],
                                           ['Netherlands Antilles', 'Netherlands Antilles'],
                                           ['New Caledonia', 'New Caledonia'],
                                           ['New Zealand', 'New Zealand'],
                                           ['Nicaragua', 'Nicaragua'],
                                           ['Niger', 'Niger'],
                                           ['Nigeria', 'Nigeria'],
                                           ['Niue', 'Niue'],
                                           ['Norfolk Island', 'Norfolk Island'],
                                           ['Northern Mariana Islands', 'Northern Mariana Islands'],
                                           ['Norway', 'Norway'],
                                           ['Oman', 'Oman'],
                                           ['Pakistan', 'Pakistan'],
                                           ['Palau', 'Palau'],
                                           ['Palestinian Territory, Occupied', 'Palestinian Territory, Occupied'],
                                           ['Panama', 'Panama'],
                                           ['Papua New Guinea', 'Papua New Guinea'],
                                           ['Paraguay', 'Paraguay'],
                                           ['Peru', 'Peru'],
                                           ['Philippines', 'Philippines'],
                                           ['Pitcairn', 'Pitcairn'],
                                           ['Poland', 'Poland'],
                                           ['Portugal', 'Portugal'],
                                           ['Puerto Rico', 'Puerto Rico'],
                                           ['Qatar', 'Qatar'],
                                           ['Reunion', 'Reunion'],
                                           ['Romania', 'Romania'],
                                           ['Russian Federation', 'Russian Federation'],
                                           ['Rwanda', 'Rwanda'],
                                           ['Saint Helena', 'Saint Helena'],
                                           ['Saint Kitts and Nevis', 'Saint Kitts and Nevis'],
                                           ['Saint Lucia', 'Saint Lucia'],
                                           ['Saint Pierre and Miquelon', 'Saint Pierre and Miquelon'],
                                           ['Saint Vincent and The Grenadines', 'Saint Vincent and The Grenadines'],
                                           ['Samoa', 'Samoa'],
                                           ['San Marino', 'San Marino'],
                                           ['Sao Tome and Principe', 'Sao Tome and Principe'],
                                           ['Saudi Arabia', 'Saudi Arabia'],
                                           ['Senegal', 'Senegal'],
                                           ['Serbia', 'Serbia'],
                                           ['Seychelles', 'Seychelles'],
                                           ['Sierra Leone', 'Sierra Leone'],
                                           ['Singapore', 'Singapore'],
                                           ['Slovakia', 'Slovakia'],
                                           ['Slovenia', 'Slovenia'],
                                           ['Solomon Islands', 'Solomon Islands'],
                                           ['Somalia', 'Somalia'],
                                           ['South Africa', 'South Africa'],
                                           ['South Georgia and The South Sandwich Islands', 'South Georgia and The South Sandwich Islands'],
                                           ['Spain', 'Spain'],
                                           ['Sri Lanka', 'Sri Lanka'],
                                           ['Sudan', 'Sudan'],
                                           ['Suriname', 'Suriname'],
                                           ['Svalbard and Jan Mayen', 'Svalbard and Jan Mayen'],
                                           ['Swaziland', 'Swaziland'],
                                           ['Sweden', 'Sweden'],
                                           ['Switzerland', 'Switzerland'],
                                           ['Syrian Arab Republic', 'Syrian Arab Republic'],
                                           ['Taiwan, Province of China', 'Taiwan, Province of China'],
                                           ['Tajikistan', 'Tajikistan'],
                                           ['Tanzania, United Republic of', 'Tanzania, United Republic of'],
                                           ['Thailand', 'Thailand'],
                                           ['Timor-leste', 'Timor-leste'],
                                           ['Togo', 'Togo'],
                                           ['Tokelau', 'Tokelau'],
                                           ['Tonga', 'Tonga'],
                                           ['Trinidad and Tobago', 'Trinidad and Tobago'],
                                           ['Tunisia', 'Tunisia'],
                                           ['Turkey', 'Turkey'],
                                           ['Turkmenistan', 'Turkmenistan'],
                                           ['Turks and Caicos Islands', 'Turks and Caicos Islands'],
                                           ['Tuvalu', 'Tuvalu'],
                                           ['Uganda', 'Uganda'],
                                           ['Ukraine', 'Ukraine'],
                                           ['United Arab Emirates', 'United Arab Emirates'],
                                           ['United Kingdom', 'United Kingdom'],
                                           ['United States', 'United States'],
                                           ['United States Minor Outlying Islands', 'United States Minor Outlying Islands'],
                                           ['Uruguay', 'Uruguay'],
                                           ['Uzbekistan', 'Uzbekistan'],
                                           ['Vanuatu', 'Vanuatu'],
                                           ['Venezuela', 'Venezuela'],
                                           ['Viet Nam', 'Viet Nam'],
                                           ['Virgin Islands, British', 'Virgin Islands, British'],
                                           ['Virgin Islands, U.S.', 'Virgin Islands, U.S.'],
                                           ['Wallis and Futuna', 'Wallis and Futuna'],
                                           ['Western Sahara', 'Western Sahara'],
                                           ['Yemen', 'Yemen'],
                                           ['Zambia', 'Zambia'],
                                           ['Zimbabwe', 'Zimbabwe']
                                         ]),
                      { prompt: 'Select your current country' },
                      { class: "form-select", required: true, id: "country-field" }
      %>
    </div>
  </div>

  <div class="mb-3">
    <%= form.label :description, class: "form-label" %>
    <%= form.text_area :description, class: "form-control", rows: 4, placeholder: "Describe this destination...", maxlength: 500 %>
    <small class="form-text text-muted">Max 500 characters.</small>
  </div>

  <div class="row">
    <div class="col-md-6 mb-3">
      <%= form.label :safety_preference, "Acceptable Safety Levels", class: "form-label" %>
      <span class="text-danger">*</span>
      <%= form.select :safety_preference,
                      [
                        ["Level 1 - Safe Destinations (Exercise normal precautions)", "Very Safe"],
                        ["Level 2 - Moderate Caution (Exercise increased caution)", "Generally Safe"],
                        ["Level 3 - High Risk (Reconsider travel)", "Partly Safe"],
                        ["Level 4 - Extreme Risk (Do not travel, Adventure style only)", "Not Safe"]
                      ],
                      { prompt: "Select safety level" },
                      class: "form-select",
                      required: true %>
    </div>

    <div class="col-md-6 mb-3">
      <%= form.label :average_cost, "Total Cost ($)", class: "form-label" %>
      <div class="input-group">
        <span class="input-group-text">$</span>
        <%= form.number_field :average_cost,
                              class: "form-control",
                              placeholder: "e.g., 150",
                              min: 0,
                              max: 999999999,
                              step: 1,
                              required: true,
                              pattern: "\d{1,9}" %>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6 mb-3">
      <%= form.label :best_season, "Best Time of Year", class: "form-label" %>
      <%= form.select :best_season,
                      Date::MONTHNAMES.compact.map { |m| [m, m] },
                      { prompt: "Select month" },
                      class: "form-select",
                      required: true %>
    </div>

    <div class="col-md-6 mb-3">
      <label class="form-label">Visa Required?</label>
      <div class="form-check">
        <%= form.check_box :visa_required, class: "form-check-input" %>
        <%= form.label :visa_required, "Yes, visa is required", class: "form-check-label" %>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-6 mb-3">
      <%= form.label :latitude, class: "form-label" %>
      <%= form.text_field :latitude, class: "form-control", readonly: true, id: "latitude-field" %>
    </div>

    <div class="col-md-6 mb-3">
      <%= form.label :longitude, class: "form-label" %>
      <%= form.text_field :longitude, class: "form-control", readonly: true, id: "longitude-field" %>
    </div>
  </div>

  <div class="d-grid">
    <%= form.submit destination.new_record? ? "Create Destination" : "Update Destination", class: "btn btn-primary" %>
  </div>
<% end %>

<script src="https://maps.googleapis.com/maps/api/js?key=<%= ENV['GOOGLE_MAPS_API_KEY'] %>&libraries=places"></script>
<script>
    // Google Places Autocomplete for city
    function initAutocomplete() {
        const cityInput = document.getElementById('city-field');
        const autocomplete = new google.maps.places.Autocomplete(cityInput, { types: ['(cities)'] });

        autocomplete.addListener('place_changed', () => {
            const place = autocomplete.getPlace();
            if (!place.geometry) {
                alert("Please select a valid destination from the dropdown.");
                cityInput.value = "";
                return;
            }
            document.getElementById('latitude-field').value = place.geometry.location.lat();
            document.getElementById('longitude-field').value = place.geometry.location.lng();
        });
    }
    google.maps.event.addDomListener(window, 'load', initAutocomplete);

    // Form validation
    document.getElementById('destination-form').addEventListener('submit', function(event) {
        let valid = true;

        // Check name
        const name = document.getElementById('destination_name');
        if (name.value.length > 75) { valid = false; name.classList.add('is-invalid'); }
        else { name.classList.remove('is-invalid'); }

        // Check city
        const city = document.getElementById('city-field');
        if (city.value.length > 75 || !document.getElementById('latitude-field').value || !document.getElementById('longitude-field').value) {
            valid = false;
            city.classList.add('is-invalid');
        } else { city.classList.remove('is-invalid'); }

        // Check description
        const desc = document.getElementById('destination_description');
        if (desc.value.length > 300) { valid = false; desc.classList.add('is-invalid'); }
        else { desc.classList.remove('is-invalid'); }

        // Check total cost
        const cost = document.getElementById('destination_average_cost');
        if (!/^\d{1,9}$/.test(cost.value)) { valid = false; cost.classList.add('is-invalid'); }
        else { cost.classList.remove('is-invalid'); }

        if (!valid) { event.preventDefault(); event.stopPropagation(); }
    });
</script>
